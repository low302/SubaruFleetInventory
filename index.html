<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Vehicle Inventory Management System</title>
    <link href="https://fonts.googleapis.com/css2?family=SF+Pro+Display:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --bg-primary: #1a1a1a;
            --bg-glass: rgba(30, 30, 30, 0.8);
            --bg-glass-hover: rgba(40, 40, 40, 0.9);
            --text-primary: #ffffff;
            --text-secondary: #a0a0a0;
            --accent: #0a84ff;
            --accent-hover: #409cff;
            --border: rgba(255, 255, 255, 0.1);
            --shadow: rgba(0, 0, 0, 0.5);
            --success: #30d158;
            --warning: #ff9f0a;
            --danger: #ff453a;
            --card-bg: rgba(30, 30, 30, 0.95);
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'SF Pro Display', 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 50%, #0f3460 100%);
            min-height: 100vh;
            color: var(--text-primary);
        }

        /* Login Screen Styles */
        .login-screen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 10000;
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 50%, #0f3460 100%);
        }

        .login-container {
            background: rgba(30, 30, 30, 0.95);
            backdrop-filter: blur(20px);
            border-radius: 24px;
            border: 1px solid rgba(255, 255, 255, 0.2);
            padding: 3rem;
            width: 90%;
            max-width: 400px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.5);
        }

        .login-header {
            text-align: center;
            margin-bottom: 2rem;
        }

        .login-header h1 {
            font-size: 1.75rem;
            font-weight: 700;
            color: var(--accent);
            margin-bottom: 0.5rem;
        }

        .login-header p {
            font-size: 1rem;
            color: var(--text-secondary);
        }

        .login-error {
            color: var(--danger);
            font-size: 0.875rem;
            margin: 1rem 0;
            text-align: center;
            min-height: 1.25rem;
        }

        #mainApp {
            width: 100%;
            height: 100vh;
        }

        .sidebar {
            position: fixed;
            left: 0;
            top: 0;
            width: 280px;
            height: 100vh;
            background: rgba(20, 20, 20, 0.95);
            backdrop-filter: blur(20px);
            padding: 2rem;
            box-shadow: 2px 0 20px var(--shadow);
            z-index: 100;
            border-right: 1px solid var(--border);
            display: flex;
            flex-direction: column;
        }

        .logo {
            font-size: 1.25rem;
            font-weight: 700;
            margin-bottom: 3rem;
            color: var(--accent);
            line-height: 1.3;
        }

        .nav-menu {
            list-style: none;
        }

        .nav-item {
            margin-bottom: 0.5rem;
        }

        .nav-link {
            display: flex;
            align-items: center;
            padding: 0.875rem 1rem;
            color: var(--text-primary);
            text-decoration: none;
            border-radius: 12px;
            transition: all 0.3s ease;
            font-weight: 500;
            cursor: pointer;
        }

        .nav-link:hover {
            background: rgba(10, 132, 255, 0.15);
            color: var(--accent);
        }

        .nav-link.active {
            background: var(--accent);
            color: white;
        }

        .nav-icon {
            margin-right: 0.75rem;
            font-size: 1.25rem;
        }

        .main-content {
            margin-left: 280px;
            padding: 2rem;
            min-height: 100vh;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
        }

        .header {
            margin-bottom: 2rem;
            animation: fadeInDown 0.6s ease;
        }

        .header h1 {
            font-size: 2.5rem;
            font-weight: 700;
            color: white;
            text-shadow: 0 2px 20px rgba(0, 0, 0, 0.2);
            margin-bottom: 0.5rem;
            letter-spacing: -0.02em;
        }

        .header p {
            font-size: 1.1rem;
            color: rgba(255, 255, 255, 0.9);
            font-weight: 400;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 1.5rem;
            margin-bottom: 2rem;
        }

        .stat-card {
            background: var(--bg-glass);
            backdrop-filter: blur(20px) saturate(180%);
            border-radius: 20px;
            border: 1px solid rgba(255, 255, 255, 0.3);
            padding: 1.5rem;
            box-shadow: 0 8px 32px var(--shadow);
            animation: fadeInUp 0.6s ease;
            animation-fill-mode: both;
        }

        .stat-card:nth-child(2) { animation-delay: 0.1s; }
        .stat-card:nth-child(3) { animation-delay: 0.2s; }
        .stat-card:nth-child(4) { animation-delay: 0.3s; }

        .stat-label {
            font-size: 0.875rem;
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 0.05em;
            margin-bottom: 0.5rem;
            font-weight: 600;
        }

        .stat-value {
            font-size: 2.5rem;
            font-weight: 700;
            color: var(--text-primary);
        }

        .stat-change {
            font-size: 0.875rem;
            margin-top: 0.5rem;
            font-weight: 500;
        }

        .stat-change.positive {
            color: var(--success);
        }

        .card {
            background: var(--bg-glass);
            backdrop-filter: blur(20px) saturate(180%);
            border-radius: 24px;
            border: 1px solid rgba(255, 255, 255, 0.3);
            box-shadow: 0 8px 32px var(--shadow);
            padding: 2rem;
            margin-bottom: 2rem;
            animation: fadeInUp 0.6s ease;
        }

        .card h2 {
            font-size: 1.5rem;
            font-weight: 600;
            margin-bottom: 1.5rem;
            color: var(--text-primary);
        }

        .search-filter-bar {
            display: flex;
            gap: 1rem;
            margin-bottom: 2rem;
            flex-wrap: wrap;
        }

        .search-box {
            flex: 1;
            min-width: 300px;
        }

        .search-box input {
            width: 100%;
            padding: 0.875rem 1rem;
            font-size: 1rem;
            border: 1px solid var(--border);
            border-radius: 12px;
            background: rgba(40, 40, 40, 0.6);
            transition: all 0.3s ease;
            color: var(--text-primary);
        }

        .search-box input:focus {
            outline: none;
            border-color: var(--accent);
            box-shadow: 0 0 0 4px rgba(10, 132, 255, 0.2);
            background: rgba(40, 40, 40, 0.9);
        }

        .filter-group {
            display: flex;
            gap: 1rem;
        }

        .filter-select {
            padding: 0.875rem 1rem;
            font-size: 1rem;
            border: 1px solid var(--border);
            border-radius: 12px;
            background: rgba(40, 40, 40, 0.6);
            cursor: pointer;
            transition: all 0.3s ease;
            color: var(--text-primary);
        }

        .filter-select:focus {
            outline: none;
            border-color: var(--accent);
            background: rgba(40, 40, 40, 0.9);
        }

        .vehicle-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
            gap: 1.5rem;
        }

        .vehicle-card {
            background: rgba(30, 30, 30, 0.95);
            border-radius: 16px;
            overflow: hidden;
            border: 1px solid var(--border);
            transition: all 0.3s ease;
            cursor: pointer;
        }

        .vehicle-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 12px 40px rgba(0, 0, 0, 0.6);
            border-color: rgba(10, 132, 255, 0.3);
        }

        .vehicle-header {
            background: linear-gradient(135deg, #0a84ff, #0051a8);
            color: white;
            padding: 1.5rem;
        }

        .vehicle-stock {
            font-size: 1.5rem;
            font-weight: 700;
            margin-bottom: 0.25rem;
        }

        .vehicle-title {
            font-size: 1.125rem;
            font-weight: 500;
            opacity: 0.9;
        }

        .vehicle-body {
            padding: 1.5rem;
        }

        .vehicle-info {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 1rem;
            margin-bottom: 1rem;
        }

        .info-item {
            font-size: 0.875rem;
        }

        .info-label {
            color: var(--text-secondary);
            font-weight: 500;
            text-transform: uppercase;
            font-size: 0.75rem;
            letter-spacing: 0.05em;
            margin-bottom: 0.25rem;
        }

        .info-value {
            color: var(--text-primary);
            font-weight: 600;
        }

        .vehicle-actions {
            display: flex;
            gap: 0.5rem;
            margin-top: 1rem;
            padding-top: 1rem;
            border-top: 1px solid var(--border);
        }

        .btn {
            background: var(--accent);
            color: white;
            border: none;
            padding: 0.75rem 1.5rem;
            font-size: 0.9rem;
            font-weight: 600;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 16px rgba(10, 132, 255, 0.4);
        }

        .btn:hover {
            background: var(--accent-hover);
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(10, 132, 255, 0.5);
        }

        .btn-small {
            padding: 0.5rem 1rem;
            font-size: 0.85rem;
            flex: 1;
        }

        .btn-secondary {
            background: rgba(60, 60, 60, 0.8);
            color: var(--text-primary);
            box-shadow: none;
        }

        .btn-secondary:hover {
            background: rgba(70, 70, 70, 0.9);
        }

        .btn-danger {
            background: var(--danger);
            box-shadow: 0 4px 16px rgba(255, 69, 58, 0.4);
        }

        .btn-danger:hover {
            background: #ff6961;
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.85);
            backdrop-filter: blur(10px);
            z-index: 1000;
            align-items: center;
            justify-content: center;
            animation: fadeIn 0.3s ease;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: rgba(25, 25, 25, 0.98);
            border: 1px solid var(--border);
            border-radius: 24px;
            padding: 2.5rem;
            max-width: 600px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
            animation: slideUp 0.3s ease;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 2rem;
        }

        .modal-header h2 {
            font-size: 1.75rem;
            font-weight: 700;
        }

        .close-btn {
            background: none;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            color: var(--text-secondary);
            transition: color 0.3s ease;
        }

        .close-btn:hover {
            color: var(--text-primary);
        }

        .form-group {
            margin-bottom: 1.5rem;
        }

        .form-group label {
            display: block;
            font-size: 0.875rem;
            font-weight: 500;
            color: var(--text-primary);
            margin-bottom: 0.5rem;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        .form-group input,
        .form-group select {
            width: 100%;
            padding: 0.875rem 1rem;
            font-size: 1rem;
            border: 1px solid var(--border);
            border-radius: 12px;
            background: rgba(40, 40, 40, 0.6);
            transition: all 0.3s ease;
            font-family: inherit;
            color: var(--text-primary);
        }

        .form-group input:focus,
        .form-group select:focus {
            outline: none;
            border-color: var(--accent);
            box-shadow: 0 0 0 4px rgba(10, 132, 255, 0.2);
            background: rgba(40, 40, 40, 0.9);
        }

        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1rem;
        }

        .label-preview {
            margin-top: 2rem;
            text-align: center;
        }

        .label {
            width: 192px;
            height: 192px;
            background: white;
            border: 2px solid #000;
            padding: 8px;
            position: relative;
            font-family: 'Courier New', monospace;
            margin: 0 auto;
        }

        .label-header {
            text-align: center;
            font-size: 18px;
            font-weight: bold;
            margin-bottom: 8px;
            padding-bottom: 4px;
            border-bottom: 2px solid #000;
            color: #000;
        }

        .label-content {
            display: flex;
            gap: 8px;
        }

        .label-info {
            flex: 1;
            font-size: 8px;
            line-height: 1.4;
            color: #000;
        }

        .label-info div {
            margin-bottom: 2px;
            color: #000;
        }

        .label-info strong {
            color: #000;
            font-weight: bold;
        }

        .label-qr {
            width: 80px;
            height: 80px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .label-qr canvas {
            max-width: 100%;
            max-height: 100%;
        }

        .empty-state {
            text-align: center;
            padding: 4rem 2rem;
            color: var(--text-secondary);
        }

        .empty-state-icon {
            font-size: 4rem;
            margin-bottom: 1rem;
            opacity: 0.5;
        }

        .chart-container {
            position: relative;
            height: 300px;
            margin-top: 1rem;
        }

        @keyframes fadeInDown {
            from {
                opacity: 0;
                transform: translateY(-20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        @keyframes slideUp {
            from {
                opacity: 0;
                transform: translateY(50px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        @media (max-width: 1024px) {
            .sidebar {
                transform: translateX(-100%);
            }

            .main-content {
                margin-left: 0;
            }

            .stats-grid {
                grid-template-columns: repeat(2, 1fr);
            }

            .vehicle-grid {
                grid-template-columns: 1fr;
            }
        }

        .page {
            display: none;
        }

        .page.active {
            display: block;
        }

        .fab {
            position: fixed;
            bottom: 2rem;
            right: 2rem;
            width: 60px;
            height: 60px;
            border-radius: 50%;
            background: var(--accent);
            color: white;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            box-shadow: 0 8px 24px rgba(10, 132, 255, 0.5);
            transition: all 0.3s ease;
            z-index: 50;
        }

        .fab:hover {
            transform: scale(1.1);
            box-shadow: 0 12px 32px rgba(10, 132, 255, 0.6);
        }

        .status-badge {
            display: inline-block;
            padding: 0.25rem 0.75rem;
            border-radius: 20px;
            font-size: 0.75rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        .status-in-stock {
            background: rgba(48, 209, 88, 0.2);
            color: var(--success);
            border: 1px solid rgba(48, 209, 88, 0.3);
        }

        .status-in-transit {
            background: rgba(10, 132, 255, 0.2);
            color: var(--accent);
            border: 1px solid rgba(10, 132, 255, 0.3);
        }

        .status-pdi {
            background: rgba(175, 82, 222, 0.2);
            color: #bf5af2;
            border: 1px solid rgba(175, 82, 222, 0.3);
        }

        .status-pending-pickup {
            background: rgba(255, 159, 10, 0.2);
            color: var(--warning);
            border: 1px solid rgba(255, 159, 10, 0.3);
        }

        .status-pickup-scheduled {
            background: rgba(100, 210, 255, 0.2);
            color: #64d2ff;
            border: 1px solid rgba(100, 210, 255, 0.3);
        }

        .status-sold {
            background: rgba(255, 69, 58, 0.2);
            color: var(--danger);
            border: 1px solid rgba(255, 69, 58, 0.3);
        }

        .pickup-list {
            list-style: none;
        }

        .pickup-item {
            background: rgba(40, 40, 40, 0.6);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 1rem;
            margin-bottom: 1rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: all 0.3s ease;
        }

        .pickup-item:hover {
            background: rgba(50, 50, 50, 0.8);
            border-color: var(--accent);
        }

        .pickup-info {
            flex: 1;
        }

        .pickup-vehicle {
            font-size: 1.125rem;
            font-weight: 600;
            margin-bottom: 0.25rem;
        }

        .pickup-customer {
            font-size: 0.9rem;
            color: var(--text-secondary);
            margin-bottom: 0.25rem;
        }

        .pickup-datetime {
            font-size: 0.875rem;
            color: var(--accent);
            font-weight: 500;
        }

        .checkbox-group {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            margin-bottom: 1rem;
        }

        .checkbox-group input[type="checkbox"] {
            width: 20px;
            height: 20px;
            cursor: pointer;
            accent-color: var(--accent);
        }

        .checkbox-group label {
            font-size: 1rem;
            font-weight: 500;
            cursor: pointer;
            margin: 0;
        }

        .picked-up-badge {
            background: rgba(48, 209, 88, 0.2);
            color: var(--success);
            border: 1px solid rgba(48, 209, 88, 0.3);
            padding: 0.25rem 0.75rem;
            border-radius: 20px;
            font-size: 0.75rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            display: inline-block;
        }

        /* Status Popup */
        .status-popup {
            position: fixed;
            background: rgba(30, 30, 30, 0.98);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 12px;
            padding: 0.5rem;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.5);
            z-index: 1000;
            min-width: 200px;
            max-width: 250px;
            max-height: 300px;
            overflow-y: auto;
            display: none;
        }

        .status-popup.active {
            display: block;
        }

        .status-popup-option {
            padding: 0.75rem 1rem;
            cursor: pointer;
            border-radius: 8px;
            transition: all 0.2s ease;
            font-size: 0.9rem;
            font-weight: 500;
            color: var(--text-primary);
        }

        .status-popup-option:hover {
            background: rgba(10, 132, 255, 0.2);
            color: var(--accent);
        }

        .status-popup-option.selected {
            background: rgba(10, 132, 255, 0.3);
            color: var(--accent);
            font-weight: 600;
        }

        /* Custom scrollbar for status popup */
        .status-popup::-webkit-scrollbar {
            width: 6px;
        }

        .status-popup::-webkit-scrollbar-track {
            background: rgba(0, 0, 0, 0.2);
            border-radius: 10px;
        }

        .status-popup::-webkit-scrollbar-thumb {
            background: rgba(10, 132, 255, 0.5);
            border-radius: 10px;
        }

        .status-popup::-webkit-scrollbar-thumb:hover {
            background: rgba(10, 132, 255, 0.7);
        }
    </style>
</head>
<body>
    <!-- Login Screen -->
    <div id="loginScreen" class="login-screen">
        <div class="login-container">
            <div class="login-header">
                <h1>Brandon Tomes Subaru</h1>
                <p>Fleet Department</p>
            </div>
            <form id="loginForm">
                <div class="form-group">
                    <label for="username">Username</label>
                    <input type="text" id="username" required autofocus>
                </div>
                <div class="form-group">
                    <label for="password">Password</label>
                    <input type="password" id="password" required>
                </div>
                <div id="loginError" class="login-error"></div>
                <button type="submit" class="btn" style="width: 100%;">Sign In</button>
            </form>
        </div>
    </div>

    <!-- Main Application (hidden until logged in) -->
    <div id="mainApp" style="display: none;">
    <div class="sidebar">
        <div class="logo">
            <div>Brandon Tomes Subaru</div>
            <div style="font-size: 0.85em; margin-top: 0.25rem;">Fleet Department</div>
        </div>
        <ul class="nav-menu">
            <li class="nav-item">
                <a class="nav-link active" data-page="dashboard">
                    <span class="nav-icon">üìä</span>
                    Dashboard
                </a>
            </li>
            <li class="nav-item">
                <a class="nav-link" data-page="inventory">
                    <span class="nav-icon">üöò</span>
                    Inventory
                </a>
            </li>
            <li class="nav-item">
                <a class="nav-link" data-page="in-transit">
                    <span class="nav-icon">üöö</span>
                    In-Transit
                </a>
            </li>
            <li class="nav-item">
                <a class="nav-link" data-page="pdi">
                    <span class="nav-icon">üîß</span>
                    PDI
                </a>
            </li>
            <li class="nav-item">
                <a class="nav-link" data-page="pending-pickup">
                    <span class="nav-icon">‚è≥</span>
                    Pending Pickup
                </a>
            </li>
            <li class="nav-item">
                <a class="nav-link" data-page="pickup-scheduled">
                    <span class="nav-icon">üìÖ</span>
                    Pickup Scheduled
                </a>
            </li>
            <li class="nav-item">
                <a class="nav-link" data-page="sold">
                    <span class="nav-icon">üí∞</span>
                    Sold Vehicles
                </a>
            </li>
            <li class="nav-item">
                <a class="nav-link" data-page="tradeins">
                    <span class="nav-icon">üîÑ</span>
                    Trade-Ins
                </a>
            </li>
            <li class="nav-item">
                <a class="nav-link" data-page="analytics">
                    <span class="nav-icon">üìà</span>
                    Analytics
                </a>
            </li>
        </ul>
        
        <!-- User Info Section -->
        <div style="margin-top: auto; padding: 1rem 0; border-top: 1px solid var(--border);">
            <div style="text-align: center; margin-bottom: 1rem;">
                <div style="font-size: 0.875rem; color: var(--text-secondary);">Logged in as</div>
                <div id="currentUserDisplay" style="font-weight: 600; color: var(--accent); margin-top: 0.25rem;">Zaid</div>
            </div>
        </div>
        
        <!-- Export Section -->
        <div style="padding-top: 1rem; border-top: 1px solid var(--border);">
            <button class="btn" onclick="openExportModal()" style="width: 100%; display: flex; align-items: center; justify-content: center; gap: 0.5rem; margin-bottom: 0.75rem;">
                <span>üì§</span>
                <span>Export Data</span>
            </button>
            <button class="btn btn-danger" onclick="logout()" style="width: 100%; display: flex; align-items: center; justify-content: center; gap: 0.5rem;">
                <span>üö™</span>
                <span>Logout</span>
            </button>
        </div>
    </div>

    <div class="main-content">
        <div class="container">
            <!-- Dashboard Page -->
            <div id="dashboard" class="page active">
                <div class="header">
                    <h1>Dashboard</h1>
                </div>

                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-label">Total Vehicles</div>
                        <div class="stat-value" id="totalVehicles">0</div>
                        <div class="stat-change positive">+0 this week</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">In Stock</div>
                        <div class="stat-value" id="inStockVehicles">0</div>
                        <div class="stat-change positive">Available</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">Sold</div>
                        <div class="stat-value" id="soldVehicles">0</div>
                        <div class="stat-change">This month</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">Trade-Ins</div>
                        <div class="stat-value" id="tradeInVehicles">0</div>
                        <div class="stat-change">Total</div>
                    </div>
                </div>

                <div class="card">
                    <h2>Scheduled Pickups</h2>
                    <div id="scheduledPickups"></div>
                </div>

                <div class="card">
                    <h2>Oldest Inventory</h2>
                    <div id="oldestVehicles" class="vehicle-grid"></div>
                </div>
            </div>

            <!-- Inventory Page -->
            <div id="inventory" class="page">
                <div class="header">
                    <h1>Vehicle Inventory</h1>
                    <p>Manage your entire vehicle stock</p>
                </div>

                <div class="search-filter-bar">
                    <div class="search-box">
                        <input type="text" id="searchInput" placeholder="Search by stock #, VIN, make, model...">
                    </div>
                    <div class="filter-group">
                        <select id="makeFilter" class="filter-select">
                            <option value="">All Makes</option>
                        </select>
                        <select id="statusFilter" class="filter-select">
                            <option value="">All Status</option>
                            <option value="in-stock">In Stock</option>
                            <option value="in-transit">In-Transit</option>
                            <option value="pdi">PDI</option>
                            <option value="pending-pickup">Pending Pickup</option>
                            <option value="pickup-scheduled">Pickup Scheduled</option>
                        </select>
                    </div>
                </div>

                <div id="inventoryGrid" class="vehicle-grid"></div>
            </div>

            <!-- In-Transit Page -->
            <div id="in-transit" class="page">
                <div class="header">
                    <h1>In-Transit Vehicles</h1>
                    <p>Vehicles currently being shipped</p>
                </div>

                <div class="search-filter-bar">
                    <div class="search-box">
                        <input type="text" id="transitSearchInput" placeholder="Search vehicles...">
                    </div>
                    <div class="filter-group">
                        <select id="transitMakeFilter" class="filter-select">
                            <option value="">All Makes</option>
                        </select>
                    </div>
                </div>

                <div id="transitGrid" class="vehicle-grid"></div>
            </div>

            <!-- PDI Page -->
            <div id="pdi" class="page">
                <div class="header">
                    <h1>PDI (Pre-Delivery Inspection)</h1>
                    <p>Vehicles undergoing inspection</p>
                </div>

                <div class="search-filter-bar">
                    <div class="search-box">
                        <input type="text" id="pdiSearchInput" placeholder="Search vehicles...">
                    </div>
                    <div class="filter-group">
                        <select id="pdiMakeFilter" class="filter-select">
                            <option value="">All Makes</option>
                        </select>
                    </div>
                </div>

                <div id="pdiGrid" class="vehicle-grid"></div>
            </div>

            <!-- Pending Pickup Page -->
            <div id="pending-pickup" class="page">
                <div class="header">
                    <h1>Pending Pickup</h1>
                    <p>Vehicles ready for customer pickup</p>
                </div>

                <div class="search-filter-bar">
                    <div class="search-box">
                        <input type="text" id="pendingPickupSearchInput" placeholder="Search vehicles...">
                    </div>
                    <div class="filter-group">
                        <select id="pendingPickupMakeFilter" class="filter-select">
                            <option value="">All Makes</option>
                        </select>
                    </div>
                </div>

                <div id="pendingPickupGrid" class="vehicle-grid"></div>
            </div>

            <!-- Pickup Scheduled Page -->
            <div id="pickup-scheduled" class="page">
                <div class="header">
                    <h1>Pickup Scheduled</h1>
                    <p>Vehicles with scheduled pickup appointments</p>
                </div>

                <div class="search-filter-bar">
                    <div class="search-box">
                        <input type="text" id="pickupScheduledSearchInput" placeholder="Search vehicles...">
                    </div>
                    <div class="filter-group">
                        <select id="pickupScheduledMakeFilter" class="filter-select">
                            <option value="">All Makes</option>
                        </select>
                    </div>
                </div>

                <div id="pickupScheduledGrid" class="vehicle-grid"></div>
            </div>

            <!-- Analytics Page -->
            <div id="analytics" class="page">
                <div class="header">
                    <h1>Analytics</h1>
                    <p>Insights and trends for your inventory</p>
                </div>

                <div class="card">
                    <h2>Inventory by Make</h2>
                    <div class="chart-container">
                        <canvas id="makeChart"></canvas>
                    </div>
                </div>

                <div class="card">
                    <h2>Inventory Timeline</h2>
                    <div class="chart-container">
                        <canvas id="timelineChart"></canvas>
                    </div>
                </div>
            </div>

            <!-- Sold Vehicles Page -->
            <div id="sold" class="page">
                <div class="header">
                    <h1>Sold Vehicles</h1>
                    <p>Completed sales and customer records</p>
                </div>

                <div class="search-filter-bar">
                    <div class="search-box">
                        <input type="text" id="soldSearchInput" placeholder="Search sold vehicles...">
                    </div>
                    <div class="filter-group">
                        <select id="soldMakeFilter" class="filter-select">
                            <option value="">All Makes</option>
                        </select>
                    </div>
                </div>

                <div id="soldGrid" class="vehicle-grid"></div>
            </div>

            <!-- Trade-Ins Page -->
            <div id="tradeins" class="page">
                <div class="header">
                    <h1>Trade-Ins</h1>
                    <p>Used vehicles received in trade</p>
                </div>

                <div class="search-filter-bar">
                    <div class="search-box">
                        <input type="text" id="tradeInSearchInput" placeholder="Search trade-ins...">
                    </div>
                    <div class="filter-group">
                        <select id="tradeInMakeFilter" class="filter-select">
                            <option value="">All Makes</option>
                        </select>
                    </div>
                </div>

                <div id="tradeInGrid" class="vehicle-grid"></div>
            </div>
        </div>
    </div>

    <!-- Floating Action Button -->
    <button class="fab" onclick="openAddModal()">+</button>

    <!-- Add Vehicle Modal -->
    <div id="addModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Add New Vehicle</h2>
                <button class="close-btn" onclick="closeAddModal()">&times;</button>
            </div>
            <form id="vehicleForm">
                <div class="form-group">
                    <label for="stockNumber">Stock #</label>
                    <input type="text" id="stockNumber" required>
                </div>

                <div class="form-group">
                    <label for="vin">VIN</label>
                    <input type="text" id="vin" maxlength="17" required>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label for="year">Year</label>
                        <input type="number" id="year" min="1900" max="2099" required>
                    </div>
                    <div class="form-group">
                        <label for="make">Make</label>
                        <input type="text" id="make" required>
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label for="model">Model</label>
                        <input type="text" id="model" required>
                    </div>
                    <div class="form-group">
                        <label for="trim">Trim</label>
                        <input type="text" id="trim" required>
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label for="color">Color</label>
                        <input type="text" id="color" required>
                    </div>
                    <div class="form-group">
                        <label for="fleetCompany">Fleet Company</label>
                        <input type="text" id="fleetCompany">
                    </div>
                </div>

                <div class="form-group">
                    <label for="status">Status</label>
                    <select id="status" required>
                        <option value="in-stock">In Stock</option>
                        <option value="in-transit">In-Transit</option>
                        <option value="pdi">PDI</option>
                        <option value="pending-pickup">Pending Pickup</option>
                        <option value="pickup-scheduled">Pickup Scheduled</option>
                        <option value="sold">Sold</option>
                    </select>
                </div>

                <button type="submit" class="btn" style="width: 100%;">Add Vehicle</button>
            </form>
        </div>
    </div>

    <!-- Vehicle Detail Modal -->
    <div id="detailModal" class="modal">
        <div class="modal-content" style="max-width: 700px;">
            <div class="modal-header">
                <h2>Vehicle Details</h2>
                <button class="close-btn" onclick="closeDetailModal()">&times;</button>
            </div>
            <div id="detailContent"></div>
            
            <!-- Status Update Section -->
            <div style="margin-top: 2rem; padding-top: 2rem; border-top: 1px solid var(--border);">
                <h3 style="font-size: 1.25rem; margin-bottom: 1rem;">Update Status</h3>
                <div class="form-group">
                    <label for="detailStatus">Vehicle Status</label>
                    <select id="detailStatus" class="filter-select" style="width: 100%;">
                        <option value="in-stock">In Stock</option>
                        <option value="in-transit">In-Transit</option>
                        <option value="pdi">PDI</option>
                        <option value="pending-pickup">Pending Pickup</option>
                        <option value="pickup-scheduled">Pickup Scheduled</option>
                        <option value="sold">Sold</option>
                    </select>
                </div>
                <button class="btn btn-secondary" onclick="updateVehicleStatus()" style="width: 100%;">Update Status</button>
            </div>

            <!-- Label Section -->
            <div style="margin-top: 2rem; padding-top: 2rem; border-top: 1px solid var(--border);">
                <h3 style="font-size: 1.25rem; margin-bottom: 1rem;">Vehicle Label</h3>
                <p style="font-size: 0.875rem; color: var(--text-secondary); margin-bottom: 1rem;">Generate a QR code label for this vehicle.</p>
                <button class="btn btn-secondary" onclick="generateLabelFromDetail()" style="width: 100%;">üè∑Ô∏è Generate Label</button>
            </div>

            <!-- Customer Information Section -->
            <div style="margin-top: 2rem; padding-top: 2rem; border-top: 1px solid var(--border);">
                <h3 style="font-size: 1.25rem; margin-bottom: 1rem;">Customer Information</h3>
                <form id="customerForm" onsubmit="saveCustomerInfo(event)">
                    <div class="form-row">
                        <div class="form-group">
                            <label for="customerFirstName">First Name</label>
                            <input type="text" id="customerFirstName">
                        </div>
                        <div class="form-group">
                            <label for="customerLastName">Last Name</label>
                            <input type="text" id="customerLastName">
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="customerEmail">Email</label>
                        <input type="email" id="customerEmail">
                    </div>
                    <div class="form-group">
                        <label for="customerPhone">Phone Number</label>
                        <input type="tel" id="customerPhone">
                    </div>
                    <div class="form-group">
                        <label for="customerAddress">Address</label>
                        <input type="text" id="customerAddress">
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="customerCity">City</label>
                            <input type="text" id="customerCity">
                        </div>
                        <div class="form-group">
                            <label for="customerState">State</label>
                            <input type="text" id="customerState">
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="customerZip">ZIP Code</label>
                            <input type="text" id="customerZip">
                        </div>
                        <div class="form-group">
                            <label for="paymentType">Payment Type</label>
                            <input type="text" id="paymentType" placeholder="e.g., Cash, Finance, Lease">
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="saleDate">Sale Date</label>
                        <input type="date" id="saleDate">
                    </div>
                    <div class="form-group">
                        <label for="notes">Notes</label>
                        <textarea id="notes" rows="3" style="width: 100%; padding: 0.875rem 1rem; font-size: 1rem; border: 1px solid var(--border); border-radius: 12px; background: rgba(40, 40, 40, 0.6); font-family: inherit; resize: vertical; color: var(--text-primary);"></textarea>
                    </div>
                    <button type="submit" class="btn" style="width: 100%;">Save Customer Information</button>
                </form>
            </div>

            <!-- Delete Vehicle Section -->
            <div id="detailDeleteSection" style="margin-top: 2rem; padding-top: 2rem; border-top: 1px solid var(--border);">
                <h3 style="font-size: 1.25rem; margin-bottom: 1rem; color: var(--danger);">Danger Zone</h3>
                <p style="font-size: 0.875rem; color: var(--text-secondary); margin-bottom: 1rem;">Once you delete a vehicle, there is no going back. Please be certain.</p>
                <button class="btn btn-danger" onclick="deleteVehicle(window.currentVehicleId)" style="width: 100%;">Delete Vehicle</button>
            </div>
        </div>
    </div>

    <!-- Label Modal -->
    <div id="labelModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Vehicle Label</h2>
                <button class="close-btn" onclick="closeLabelModal()">&times;</button>
            </div>
            <div class="label-preview">
                <div class="label" id="label">
                    <div class="label-header" id="labelStockNumber"></div>
                    <div class="label-content">
                        <div class="label-info" id="labelInfo"></div>
                        <div class="label-qr" id="labelQR"></div>
                    </div>
                </div>
                <div style="display: flex; gap: 1rem; margin-top: 1.5rem;">
                    <button class="btn btn-secondary" onclick="printLabel()" style="flex: 1;">Print</button>
                    <button class="btn btn-secondary" onclick="saveLabel()" style="flex: 1;">Save</button>
                    <button class="btn btn-secondary" onclick="copyLabel()" style="flex: 1;">Copy</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Trade-In Modal -->
    <div id="tradeInModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Add Trade-In Vehicle</h2>
                <button class="close-btn" onclick="closeTradeInModal()">&times;</button>
            </div>
            <form id="tradeInForm">
                <div class="form-group">
                    <label for="tradeStockNumber">Stock # (Optional)</label>
                    <input type="text" id="tradeStockNumber">
                </div>

                <div class="form-group">
                    <label for="tradeVin">VIN</label>
                    <input type="text" id="tradeVin" maxlength="17" required>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label for="tradeYear">Year</label>
                        <input type="number" id="tradeYear" min="1900" max="2099" required>
                    </div>
                    <div class="form-group">
                        <label for="tradeMake">Make</label>
                        <input type="text" id="tradeMake" required>
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label for="tradeModel">Model</label>
                        <input type="text" id="tradeModel" required>
                    </div>
                    <div class="form-group">
                        <label for="tradeTrim">Trim (Optional)</label>
                        <input type="text" id="tradeTrim">
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label for="tradeColor">Color</label>
                        <input type="text" id="tradeColor" required>
                    </div>
                    <div class="form-group">
                        <label for="tradeMileage">Mileage</label>
                        <input type="number" id="tradeMileage" min="0">
                    </div>
                </div>

                <div class="form-group">
                    <label for="tradeNotes">Notes</label>
                    <textarea id="tradeNotes" rows="3" style="width: 100%; padding: 0.875rem 1rem; font-size: 1rem; border: 1px solid var(--border); border-radius: 12px; background: rgba(40, 40, 40, 0.6); font-family: inherit; resize: vertical; color: var(--text-primary);"></textarea>
                </div>

                <button type="submit" class="btn" style="width: 100%;">Add Trade-In</button>
            </form>
        </div>
    </div>

    <!-- Trade-In Pickup Date Modal -->
    <div id="tradePickupModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Trade-In Pickup Date</h2>
                <button class="close-btn" onclick="closeTradePickupModal()">&times;</button>
            </div>
            <form id="tradePickupForm">
                <div class="form-group">
                    <label for="tradePickupDate">Pickup Date</label>
                    <input type="date" id="tradePickupDate" required>
                </div>

                <button type="submit" class="btn" style="width: 100%;">Confirm Pickup</button>
            </form>
        </div>
    </div>

    <!-- Pickup Schedule Modal -->
    <div id="pickupScheduleModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Schedule Pickup</h2>
                <button class="close-btn" onclick="closePickupScheduleModal()">&times;</button>
            </div>
            <form id="pickupScheduleForm">
                <div class="form-group">
                    <label for="pickupDate">Pickup Date</label>
                    <input type="date" id="pickupDate" required>
                </div>

                <div class="form-group">
                    <label for="pickupTime">Pickup Time</label>
                    <input type="time" id="pickupTime" required>
                </div>

                <div class="form-group">
                    <label for="pickupNotes">Notes (Optional)</label>
                    <textarea id="pickupNotes" rows="3" style="width: 100%; padding: 0.875rem 1rem; font-size: 1rem; border: 1px solid var(--border); border-radius: 12px; background: rgba(40, 40, 40, 0.6); font-family: inherit; resize: vertical; color: var(--text-primary);"></textarea>
                </div>

                <button type="submit" class="btn" style="width: 100%;">Schedule Pickup</button>
            </form>
        </div>
    </div>

    <!-- Status Popup -->
    <div id="statusPopup" class="status-popup"></div>

    <!-- Export Modal -->
    <div id="exportModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>üì§ Export Data</h2>
                <button class="close-btn" onclick="closeExportModal()">&times;</button>
            </div>
            <div style="padding: 1rem 0;">
                <p style="color: var(--text-secondary); margin-bottom: 2rem;">Choose which data you want to export as CSV:</p>
                
                <div style="display: flex; flex-direction: column; gap: 1rem;">
                    <button class="btn" onclick="exportAllInventory()" style="width: 100%; text-align: left; display: flex; align-items: center; gap: 1rem;">
                        <span style="font-size: 1.5rem;">üöò</span>
                        <div>
                            <div style="font-weight: 600;">All Inventory</div>
                            <div style="font-size: 0.875rem; opacity: 0.7;">Export all vehicles (excluding sold)</div>
                        </div>
                    </button>
                    
                    <button class="btn" onclick="exportByStatus('in-stock')" style="width: 100%; text-align: left; display: flex; align-items: center; gap: 1rem;">
                        <span style="font-size: 1.5rem;">‚úÖ</span>
                        <div>
                            <div style="font-weight: 600;">In Stock Only</div>
                            <div style="font-size: 0.875rem; opacity: 0.7;">Vehicles currently in stock</div>
                        </div>
                    </button>
                    
                    <button class="btn" onclick="exportByStatus('in-transit')" style="width: 100%; text-align: left; display: flex; align-items: center; gap: 1rem;">
                        <span style="font-size: 1.5rem;">üöö</span>
                        <div>
                            <div style="font-weight: 600;">In-Transit</div>
                            <div style="font-size: 0.875rem; opacity: 0.7;">Vehicles being shipped</div>
                        </div>
                    </button>
                    
                    <button class="btn" onclick="exportByStatus('pickup-scheduled')" style="width: 100%; text-align: left; display: flex; align-items: center; gap: 1rem;">
                        <span style="font-size: 1.5rem;">üìÖ</span>
                        <div>
                            <div style="font-weight: 600;">Pickup Scheduled</div>
                            <div style="font-size: 0.875rem; opacity: 0.7;">Vehicles with scheduled pickups</div>
                        </div>
                    </button>
                    
                    <button class="btn btn-secondary" onclick="exportSoldVehicles()" style="width: 100%; text-align: left; display: flex; align-items: center; gap: 1rem;">
                        <span style="font-size: 1.5rem;">üí∞</span>
                        <div>
                            <div style="font-weight: 600;">Sold Vehicles</div>
                            <div style="font-size: 0.875rem; opacity: 0.7;">All sold vehicles with customer info</div>
                        </div>
                    </button>
                    
                    <button class="btn btn-secondary" onclick="exportTradeIns()" style="width: 100%; text-align: left; display: flex; align-items: center; gap: 1rem;">
                        <span style="font-size: 1.5rem;">üîÑ</span>
                        <div>
                            <div style="font-weight: 600;">Trade-Ins</div>
                            <div style="font-size: 0.875rem; opacity: 0.7;">All trade-in vehicles</div>
                        </div>
                    </button>
                </div>
            </div>
        </div>
    </div>
    </div> <!-- End of mainApp -->

    <script>
        // Authentication System
        const USERS = {
            'Zaid': '1234'  // Admin account
        };

        let currentUser = localStorage.getItem('currentUser');

        // Check authentication on page load
        function checkAuth() {
            if (!currentUser) {
                showLogin();
            } else {
                showMainApp();
            }
        }

        function showLogin() {
            document.getElementById('loginScreen').style.display = 'flex';
            document.getElementById('mainApp').style.display = 'none';
        }

        function showMainApp() {
            document.getElementById('loginScreen').style.display = 'none';
            document.getElementById('mainApp').style.display = 'block';
            
            // Update user display
            const userDisplay = document.getElementById('currentUserDisplay');
            if (userDisplay && currentUser) {
                userDisplay.textContent = currentUser;
            }
        }

        // Handle login form submission
        document.addEventListener('DOMContentLoaded', () => {
            checkAuth();

            document.getElementById('loginForm').addEventListener('submit', (e) => {
                e.preventDefault();
                
                const username = document.getElementById('username').value;
                const password = document.getElementById('password').value;
                const errorDiv = document.getElementById('loginError');

                // Validate credentials
                if (USERS[username] && USERS[username] === password) {
                    // Successful login
                    localStorage.setItem('currentUser', username);
                    currentUser = username;
                    errorDiv.textContent = '';
                    showMainApp();
                    
                    // Initialize the app
                    initializeApp();
                } else {
                    // Failed login
                    errorDiv.textContent = 'Invalid username or password';
                    document.getElementById('password').value = '';
                }
            });
        });

        function logout() {
            if (confirm('Are you sure you want to logout?')) {
                localStorage.removeItem('currentUser');
                currentUser = null;
                showLogin();
                // Clear form
                document.getElementById('username').value = '';
                document.getElementById('password').value = '';
            }
        }

        // Data and Variables
        let inventory = JSON.parse(localStorage.getItem('vehicleInventory')) || [];
        let soldVehicles = JSON.parse(localStorage.getItem('soldVehicles')) || [];
        let tradeIns = JSON.parse(localStorage.getItem('tradeIns')) || [];
        let currentVehicle = null;
        let makeChart = null;
        let timelineChart = null;

        // Export Modal Functions
        function openExportModal() {
            document.getElementById('exportModal').classList.add('active');
        }

        function closeExportModal() {
            document.getElementById('exportModal').classList.remove('active');
        }

        // Export Functions
        function exportToCSV(data, filename) {
            if (!data || data.length === 0) {
                alert('No data to export!');
                return;
            }

            // Get all unique keys from all objects
            const allKeys = new Set();
            data.forEach(item => {
                Object.keys(item).forEach(key => {
                    // Exclude nested objects and arrays for cleaner export
                    if (key !== 'customer' && key !== 'documents') {
                        allKeys.add(key);
                    }
                });
                // Add customer fields if they exist
                if (item.customer) {
                    Object.keys(item.customer).forEach(key => {
                        allKeys.add('customer_' + key);
                    });
                }
            });

            const headers = Array.from(allKeys);
            
            // Create CSV header row
            let csv = headers.join(',') + '\n';
            
            // Create CSV data rows
            data.forEach(item => {
                const values = headers.map(header => {
                    let value;
                    
                    // Handle customer fields
                    if (header.startsWith('customer_')) {
                        const customerKey = header.replace('customer_', '');
                        value = item.customer ? item.customer[customerKey] : '';
                    } else {
                        value = item[header];
                    }
                    
                    // Handle different data types
                    if (value === null || value === undefined) {
                        return '';
                    }
                    
                    // Convert to string and escape quotes
                    value = String(value).replace(/"/g, '""');
                    
                    // Wrap in quotes if contains comma, newline, or quote
                    if (value.includes(',') || value.includes('\n') || value.includes('"')) {
                        return `"${value}"`;
                    }
                    
                    return value;
                });
                
                csv += values.join(',') + '\n';
            });
            
            // Create download link
            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);
            
            link.setAttribute('href', url);
            link.setAttribute('download', filename);
            link.style.visibility = 'hidden';
            
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            
            closeExportModal();
            alert(`Exported ${data.length} records to ${filename}`);
        }

        function exportAllInventory() {
            const data = inventory.map(v => ({
                stockNumber: v.stockNumber,
                vin: v.vin,
                year: v.year,
                make: v.make,
                model: v.model,
                trim: v.trim,
                color: v.color,
                fleetCompany: v.fleetCompany || '',
                status: v.status,
                dateAdded: v.dateAdded,
                pickupDate: v.pickupDate || '',
                pickupTime: v.pickupTime || ''
            }));
            
            const filename = `inventory-all-${new Date().toISOString().split('T')[0]}.csv`;
            exportToCSV(data, filename);
        }

        function exportByStatus(status) {
            const filtered = inventory.filter(v => v.status === status);
            
            const data = filtered.map(v => ({
                stockNumber: v.stockNumber,
                vin: v.vin,
                year: v.year,
                make: v.make,
                model: v.model,
                trim: v.trim,
                color: v.color,
                fleetCompany: v.fleetCompany || '',
                status: v.status,
                dateAdded: v.dateAdded,
                pickupDate: v.pickupDate || '',
                pickupTime: v.pickupTime || ''
            }));
            
            const statusName = status.replace('-', '_');
            const filename = `inventory-${statusName}-${new Date().toISOString().split('T')[0]}.csv`;
            exportToCSV(data, filename);
        }

        function exportSoldVehicles() {
            const data = soldVehicles.map(v => {
                const row = {
                    stockNumber: v.stockNumber,
                    vin: v.vin,
                    year: v.year,
                    make: v.make,
                    model: v.model,
                    trim: v.trim,
                    color: v.color,
                    fleetCompany: v.fleetCompany || '',
                    status: v.status,
                    dateAdded: v.dateAdded
                };
                
                // Add customer information
                if (v.customer) {
                    row.customer = v.customer;
                }
                
                return row;
            });
            
            const filename = `sold-vehicles-${new Date().toISOString().split('T')[0]}.csv`;
            exportToCSV(data, filename);
        }

        function exportTradeIns() {
            const data = tradeIns.map(t => ({
                stockNumber: t.stockNumber || '',
                vin: t.vin,
                year: t.year,
                make: t.make,
                model: t.model,
                trim: t.trim || '',
                color: t.color,
                mileage: t.mileage || '',
                notes: t.notes || '',
                pickedUp: t.pickedUp ? 'Yes' : 'No',
                pickedUpDate: t.pickedUpDate || '',
                dateAdded: t.dateAdded
            }));
            
            const filename = `trade-ins-${new Date().toISOString().split('T')[0]}.csv`;
            exportToCSV(data, filename);
        }

        // Initialize
        function initializeApp() {
            renderDashboard();
            renderInventory();
            renderInTransit();
            renderPDI();
            renderPendingPickup();
            renderPickupScheduled();
            renderSoldVehicles();
            renderTradeIns();
            setupNavigation();
            setupSearch();
            updateStats();
        }

        window.addEventListener('DOMContentLoaded', () => {
            // Auth check happens in the DOMContentLoaded listener above
            // initializeApp() is called after successful login
            // If already logged in, initialize immediately
            if (currentUser) {
                initializeApp();
            }
        });

        // Navigation
        function setupNavigation() {
            document.querySelectorAll('.nav-link').forEach(link => {
                link.addEventListener('click', (e) => {
                    e.preventDefault();
                    const pageName = link.dataset.page;
                    
                    // Update active states
                    document.querySelectorAll('.nav-link').forEach(l => l.classList.remove('active'));
                    link.classList.add('active');
                    
                    // Show page
                    document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
                    document.getElementById(pageName).classList.add('active');
                    
                    // Render page-specific content
                    if (pageName === 'analytics') {
                        renderAnalytics();
                    }
                });
            });
        }

        // Search and Filter
        function setupSearch() {
            const searchInput = document.getElementById('searchInput');
            const makeFilter = document.getElementById('makeFilter');
            const statusFilter = document.getElementById('statusFilter');

            searchInput.addEventListener('input', renderInventory);
            makeFilter.addEventListener('change', renderInventory);
            statusFilter.addEventListener('change', renderInventory);

            // Populate make filter
            const makes = [...new Set(inventory.filter(v => v.status !== 'sold').map(v => v.make))];
            makes.forEach(make => {
                const option = document.createElement('option');
                option.value = make;
                option.textContent = make;
                makeFilter.appendChild(option);
            });

            // Sold vehicles search
            const soldSearchInput = document.getElementById('soldSearchInput');
            const soldMakeFilter = document.getElementById('soldMakeFilter');

            if (soldSearchInput) soldSearchInput.addEventListener('input', renderSoldVehicles);
            if (soldMakeFilter) soldMakeFilter.addEventListener('change', renderSoldVehicles);

            // Trade-ins search
            const tradeInSearchInput = document.getElementById('tradeInSearchInput');
            const tradeInMakeFilter = document.getElementById('tradeInMakeFilter');

            if (tradeInSearchInput) tradeInSearchInput.addEventListener('input', renderTradeIns);
            if (tradeInMakeFilter) tradeInMakeFilter.addEventListener('change', renderTradeIns);

            // In-Transit search
            const transitSearchInput = document.getElementById('transitSearchInput');
            const transitMakeFilter = document.getElementById('transitMakeFilter');

            if (transitSearchInput) transitSearchInput.addEventListener('input', renderInTransit);
            if (transitMakeFilter) transitMakeFilter.addEventListener('change', renderInTransit);

            // PDI search
            const pdiSearchInput = document.getElementById('pdiSearchInput');
            const pdiMakeFilter = document.getElementById('pdiMakeFilter');

            if (pdiSearchInput) pdiSearchInput.addEventListener('input', renderPDI);
            if (pdiMakeFilter) pdiMakeFilter.addEventListener('change', renderPDI);

            // Pending Pickup search
            const pendingPickupSearchInput = document.getElementById('pendingPickupSearchInput');
            const pendingPickupMakeFilter = document.getElementById('pendingPickupMakeFilter');

            if (pendingPickupSearchInput) pendingPickupSearchInput.addEventListener('input', renderPendingPickup);
            if (pendingPickupMakeFilter) pendingPickupMakeFilter.addEventListener('change', renderPendingPickup);

            // Pickup Scheduled search
            const pickupScheduledSearchInput = document.getElementById('pickupScheduledSearchInput');
            const pickupScheduledMakeFilter = document.getElementById('pickupScheduledMakeFilter');

            if (pickupScheduledSearchInput) pickupScheduledSearchInput.addEventListener('input', renderPickupScheduled);
            if (pickupScheduledMakeFilter) pickupScheduledMakeFilter.addEventListener('change', renderPickupScheduled);
        }

        // Add Vehicle
        document.getElementById('vehicleForm').addEventListener('submit', function(e) {
            e.preventDefault();
            
            const vehicle = {
                id: Date.now(),
                stockNumber: document.getElementById('stockNumber').value,
                vin: document.getElementById('vin').value,
                year: document.getElementById('year').value,
                make: document.getElementById('make').value,
                model: document.getElementById('model').value,
                trim: document.getElementById('trim').value,
                color: document.getElementById('color').value,
                fleetCompany: document.getElementById('fleetCompany').value,
                status: document.getElementById('status').value,
                dateAdded: new Date().toISOString(),
                customer: null
            };

            inventory.unshift(vehicle);
            localStorage.setItem('vehicleInventory', JSON.stringify(inventory));
            
            closeAddModal();
            this.reset();
            renderDashboard();
            renderInventory();
            updateStats();
            
            // Update make filter
            const makeFilter = document.getElementById('makeFilter');
            if (![...makeFilter.options].some(opt => opt.value === vehicle.make)) {
                const option = document.createElement('option');
                option.value = vehicle.make;
                option.textContent = vehicle.make;
                makeFilter.appendChild(option);
            }
        });

        // Render Dashboard
        function renderDashboard() {
            // Render scheduled pickups
            const pickupScheduledVehicles = inventory.filter(v => v.status === 'pickup-scheduled');
            const pickupsContainer = document.getElementById('scheduledPickups');
            
            if (pickupScheduledVehicles.length === 0) {
                pickupsContainer.innerHTML = '<div class="empty-state" style="padding: 2rem;"><p>No scheduled pickups</p></div>';
            } else {
                // Sort by pickup date/time
                const sortedPickups = pickupScheduledVehicles.sort((a, b) => {
                    const dateA = new Date(`${a.pickupDate}T${a.pickupTime}`);
                    const dateB = new Date(`${b.pickupDate}T${b.pickupTime}`);
                    return dateA - dateB;
                });
                
                pickupsContainer.innerHTML = '<ul class="pickup-list">' + sortedPickups.map(vehicle => {
                    const pickupDateTime = new Date(`${vehicle.pickupDate}T${vehicle.pickupTime}`);
                    const formattedDate = pickupDateTime.toLocaleDateString('en-US', { 
                        weekday: 'short', 
                        month: 'short', 
                        day: 'numeric',
                        year: 'numeric'
                    });
                    const formattedTime = pickupDateTime.toLocaleTimeString('en-US', { 
                        hour: 'numeric', 
                        minute: '2-digit'
                    });
                    
                    const customerName = vehicle.customer?.firstName || vehicle.customer?.lastName 
                        ? `${vehicle.customer.firstName || ''} ${vehicle.customer.lastName || ''}`.trim()
                        : 'Customer not set';
                    
                    return `
                        <li class="pickup-item">
                            <div class="pickup-info">
                                <div class="pickup-vehicle">${vehicle.year} ${vehicle.make} ${vehicle.model} - ${vehicle.stockNumber}</div>
                                <div class="pickup-customer">üë§ ${customerName}</div>
                                <div class="pickup-datetime">üìÖ ${formattedDate} at ${formattedTime}</div>
                            </div>
                            <button class="btn btn-small btn-secondary" onclick="viewDetails(${vehicle.id})">View</button>
                        </li>
                    `;
                }).join('') + '</ul>';
            }
            
            // Get oldest vehicles (sorted by dateAdded, ascending)
            const activeInventory = inventory.filter(v => v.status !== 'sold');
            const oldestVehicles = [...activeInventory].sort((a, b) => 
                new Date(a.dateAdded) - new Date(b.dateAdded)
            ).slice(0, 6);
            
            const container = document.getElementById('oldestVehicles');
            
            if (oldestVehicles.length === 0) {
                container.innerHTML = '<div class="empty-state"><div class="empty-state-icon">üöó</div><p>No vehicles in inventory yet</p></div>';
                return;
            }
            
            container.innerHTML = oldestVehicles.map(vehicle => createVehicleCard(vehicle)).join('');
        }

        // Render Inventory
        function renderInventory() {
            const searchTerm = document.getElementById('searchInput')?.value.toLowerCase() || '';
            const makeFilter = document.getElementById('makeFilter')?.value || '';
            const statusFilter = document.getElementById('statusFilter')?.value || '';
            
            // Filter out sold vehicles from main inventory
            let filtered = inventory.filter(vehicle => {
                if (vehicle.status === 'sold') return false;
                
                const matchesSearch = !searchTerm || 
                    vehicle.stockNumber.toLowerCase().includes(searchTerm) ||
                    vehicle.vin.toLowerCase().includes(searchTerm) ||
                    vehicle.make.toLowerCase().includes(searchTerm) ||
                    vehicle.model.toLowerCase().includes(searchTerm);
                
                const matchesMake = !makeFilter || vehicle.make === makeFilter;
                const matchesStatus = !statusFilter || vehicle.status === statusFilter;
                
                return matchesSearch && matchesMake && matchesStatus;
            });
            
            const container = document.getElementById('inventoryGrid');
            
            if (filtered.length === 0) {
                container.innerHTML = '<div class="empty-state"><div class="empty-state-icon">üîç</div><p>No vehicles found</p></div>';
                return;
            }
            
            container.innerHTML = filtered.map(vehicle => createVehicleCard(vehicle)).join('');
        }

        // Render Sold Vehicles
        function renderSoldVehicles() {
            const searchTerm = document.getElementById('soldSearchInput')?.value.toLowerCase() || '';
            const makeFilter = document.getElementById('soldMakeFilter')?.value || '';
            
            let filtered = soldVehicles.filter(vehicle => {
                const matchesSearch = !searchTerm || 
                    vehicle.stockNumber.toLowerCase().includes(searchTerm) ||
                    vehicle.vin.toLowerCase().includes(searchTerm) ||
                    vehicle.make.toLowerCase().includes(searchTerm) ||
                    vehicle.model.toLowerCase().includes(searchTerm);
                
                const matchesMake = !makeFilter || vehicle.make === makeFilter;
                
                return matchesSearch && matchesMake;
            });
            
            const container = document.getElementById('soldGrid');
            
            if (filtered.length === 0) {
                container.innerHTML = '<div class="empty-state"><div class="empty-state-icon">üí∞</div><p>No sold vehicles yet</p></div>';
                return;
            }
            
            container.innerHTML = filtered.map(vehicle => createSoldVehicleCard(vehicle)).join('');
            
            // Populate make filter
            const makeFilterEl = document.getElementById('soldMakeFilter');
            const makes = [...new Set(soldVehicles.map(v => v.make))];
            makeFilterEl.innerHTML = '<option value="">All Makes</option>';
            makes.forEach(make => {
                const option = document.createElement('option');
                option.value = make;
                option.textContent = make;
                makeFilterEl.appendChild(option);
            });
        }

        // Render Trade-Ins
        function renderTradeIns() {
            const searchTerm = document.getElementById('tradeInSearchInput')?.value.toLowerCase() || '';
            const makeFilter = document.getElementById('tradeInMakeFilter')?.value || '';
            
            let filtered = tradeIns.filter(vehicle => {
                const matchesSearch = !searchTerm || 
                    (vehicle.stockNumber && vehicle.stockNumber.toLowerCase().includes(searchTerm)) ||
                    vehicle.vin.toLowerCase().includes(searchTerm) ||
                    vehicle.make.toLowerCase().includes(searchTerm) ||
                    vehicle.model.toLowerCase().includes(searchTerm);
                
                const matchesMake = !makeFilter || vehicle.make === makeFilter;
                
                return matchesSearch && matchesMake;
            });
            
            // Sort: non-picked-up first, then picked-up at the bottom
            filtered.sort((a, b) => {
                if (a.pickedUp && !b.pickedUp) return 1;
                if (!a.pickedUp && b.pickedUp) return -1;
                // If both have same picked up status, sort by date added (newest first)
                return new Date(b.dateAdded) - new Date(a.dateAdded);
            });
            
            const container = document.getElementById('tradeInGrid');
            
            if (filtered.length === 0) {
                container.innerHTML = '<div class="empty-state"><div class="empty-state-icon">üîÑ</div><p>No trade-ins yet</p></div>';
                return;
            }
            
            container.innerHTML = filtered.map(vehicle => createTradeInCard(vehicle)).join('');
            
            // Populate make filter
            const makeFilterEl = document.getElementById('tradeInMakeFilter');
            const makes = [...new Set(tradeIns.map(v => v.make))];
            makeFilterEl.innerHTML = '<option value="">All Makes</option>';
            makes.forEach(make => {
                const option = document.createElement('option');
                option.value = make;
                option.textContent = make;
                makeFilterEl.appendChild(option);
            });
        }

        // Render In-Transit
        function renderInTransit() {
            const searchTerm = document.getElementById('transitSearchInput')?.value.toLowerCase() || '';
            const makeFilter = document.getElementById('transitMakeFilter')?.value || '';
            
            let filtered = inventory.filter(vehicle => {
                if (vehicle.status !== 'in-transit') return false;
                
                const matchesSearch = !searchTerm || 
                    vehicle.stockNumber.toLowerCase().includes(searchTerm) ||
                    vehicle.vin.toLowerCase().includes(searchTerm) ||
                    vehicle.make.toLowerCase().includes(searchTerm) ||
                    vehicle.model.toLowerCase().includes(searchTerm);
                
                const matchesMake = !makeFilter || vehicle.make === makeFilter;
                
                return matchesSearch && matchesMake;
            });
            
            const container = document.getElementById('transitGrid');
            
            if (filtered.length === 0) {
                container.innerHTML = '<div class="empty-state"><div class="empty-state-icon">üöö</div><p>No vehicles in transit</p></div>';
                return;
            }
            
            container.innerHTML = filtered.map(vehicle => createVehicleCard(vehicle)).join('');
            
            // Populate make filter
            const makeFilterEl = document.getElementById('transitMakeFilter');
            const makes = [...new Set(inventory.filter(v => v.status === 'in-transit').map(v => v.make))];
            makeFilterEl.innerHTML = '<option value="">All Makes</option>';
            makes.forEach(make => {
                const option = document.createElement('option');
                option.value = make;
                option.textContent = make;
                makeFilterEl.appendChild(option);
            });
        }

        // Render PDI
        function renderPDI() {
            const searchTerm = document.getElementById('pdiSearchInput')?.value.toLowerCase() || '';
            const makeFilter = document.getElementById('pdiMakeFilter')?.value || '';
            
            let filtered = inventory.filter(vehicle => {
                if (vehicle.status !== 'pdi') return false;
                
                const matchesSearch = !searchTerm || 
                    vehicle.stockNumber.toLowerCase().includes(searchTerm) ||
                    vehicle.vin.toLowerCase().includes(searchTerm) ||
                    vehicle.make.toLowerCase().includes(searchTerm) ||
                    vehicle.model.toLowerCase().includes(searchTerm);
                
                const matchesMake = !makeFilter || vehicle.make === makeFilter;
                
                return matchesSearch && matchesMake;
            });
            
            const container = document.getElementById('pdiGrid');
            
            if (filtered.length === 0) {
                container.innerHTML = '<div class="empty-state"><div class="empty-state-icon">üîß</div><p>No vehicles in PDI</p></div>';
                return;
            }
            
            container.innerHTML = filtered.map(vehicle => createVehicleCard(vehicle)).join('');
            
            // Populate make filter
            const makeFilterEl = document.getElementById('pdiMakeFilter');
            const makes = [...new Set(inventory.filter(v => v.status === 'pdi').map(v => v.make))];
            makeFilterEl.innerHTML = '<option value="">All Makes</option>';
            makes.forEach(make => {
                const option = document.createElement('option');
                option.value = make;
                option.textContent = make;
                makeFilterEl.appendChild(option);
            });
        }

        // Render Pending Pickup
        function renderPendingPickup() {
            const searchTerm = document.getElementById('pendingPickupSearchInput')?.value.toLowerCase() || '';
            const makeFilter = document.getElementById('pendingPickupMakeFilter')?.value || '';
            
            let filtered = inventory.filter(vehicle => {
                if (vehicle.status !== 'pending-pickup') return false;
                
                const matchesSearch = !searchTerm || 
                    vehicle.stockNumber.toLowerCase().includes(searchTerm) ||
                    vehicle.vin.toLowerCase().includes(searchTerm) ||
                    vehicle.make.toLowerCase().includes(searchTerm) ||
                    vehicle.model.toLowerCase().includes(searchTerm);
                
                const matchesMake = !makeFilter || vehicle.make === makeFilter;
                
                return matchesSearch && matchesMake;
            });
            
            const container = document.getElementById('pendingPickupGrid');
            
            if (filtered.length === 0) {
                container.innerHTML = '<div class="empty-state"><div class="empty-state-icon">‚è≥</div><p>No vehicles pending pickup</p></div>';
                return;
            }
            
            container.innerHTML = filtered.map(vehicle => createVehicleCard(vehicle)).join('');
            
            // Populate make filter
            const makeFilterEl = document.getElementById('pendingPickupMakeFilter');
            const makes = [...new Set(inventory.filter(v => v.status === 'pending-pickup').map(v => v.make))];
            makeFilterEl.innerHTML = '<option value="">All Makes</option>';
            makes.forEach(make => {
                const option = document.createElement('option');
                option.value = make;
                option.textContent = make;
                makeFilterEl.appendChild(option);
            });
        }

        // Render Pickup Scheduled
        function renderPickupScheduled() {
            const searchTerm = document.getElementById('pickupScheduledSearchInput')?.value.toLowerCase() || '';
            const makeFilter = document.getElementById('pickupScheduledMakeFilter')?.value || '';
            
            let filtered = inventory.filter(vehicle => {
                if (vehicle.status !== 'pickup-scheduled') return false;
                
                const matchesSearch = !searchTerm || 
                    vehicle.stockNumber.toLowerCase().includes(searchTerm) ||
                    vehicle.vin.toLowerCase().includes(searchTerm) ||
                    vehicle.make.toLowerCase().includes(searchTerm) ||
                    vehicle.model.toLowerCase().includes(searchTerm);
                
                const matchesMake = !makeFilter || vehicle.make === makeFilter;
                
                return matchesSearch && matchesMake;
            });
            
            // Sort by pickup date/time
            filtered.sort((a, b) => {
                const dateA = new Date(`${a.pickupDate}T${a.pickupTime}`);
                const dateB = new Date(`${b.pickupDate}T${b.pickupTime}`);
                return dateA - dateB;
            });
            
            const container = document.getElementById('pickupScheduledGrid');
            
            if (filtered.length === 0) {
                container.innerHTML = '<div class="empty-state"><div class="empty-state-icon">üìÖ</div><p>No scheduled pickups</p></div>';
                return;
            }
            
            container.innerHTML = filtered.map(vehicle => createPickupScheduledCard(vehicle)).join('');
            
            // Populate make filter
            const makeFilterEl = document.getElementById('pickupScheduledMakeFilter');
            const makes = [...new Set(inventory.filter(v => v.status === 'pickup-scheduled').map(v => v.make))];
            makeFilterEl.innerHTML = '<option value="">All Makes</option>';
            makes.forEach(make => {
                const option = document.createElement('option');
                option.value = make;
                option.textContent = make;
                makeFilterEl.appendChild(option);
            });
        }

        // Create Vehicle Card
        function createVehicleCard(vehicle) {
            const statusClass = `status-${vehicle.status}`;
            const statusText = vehicle.status.replace('-', ' ').toUpperCase();
            
            return `
                <div class="vehicle-card">
                    <div class="vehicle-header">
                        <div class="vehicle-stock">${vehicle.stockNumber}</div>
                        <div class="vehicle-title">${vehicle.year} ${vehicle.make} ${vehicle.model}</div>
                    </div>
                    <div class="vehicle-body">
                        <div style="margin-bottom: 1rem;">
                            <span class="status-badge ${statusClass}">${statusText}</span>
                        </div>
                        <div class="vehicle-info">
                            <div class="info-item">
                                <div class="info-label">VIN</div>
                                <div class="info-value">${vehicle.vin}</div>
                            </div>
                            <div class="info-item">
                                <div class="info-label">Trim</div>
                                <div class="info-value">${vehicle.trim}</div>
                            </div>
                            <div class="info-item">
                                <div class="info-label">Color</div>
                                <div class="info-value">${vehicle.color}</div>
                            </div>
                            <div class="info-item">
                                <div class="info-label">Fleet</div>
                                <div class="info-value">${vehicle.fleetCompany || 'N/A'}</div>
                            </div>
                        </div>
                        ${vehicle.customer && (vehicle.customer.firstName || vehicle.customer.lastName) ? `
                        <div style="margin-top: 1rem; padding-top: 1rem; border-top: 1px solid var(--border);">
                            <div class="info-label">Customer</div>
                            <div class="info-value" style="font-weight: 600; margin-bottom: 0.5rem;">${vehicle.customer.firstName || ''} ${vehicle.customer.lastName || ''}</div>
                            ${vehicle.customer.phone ? `<div class="info-value" style="font-size: 0.875rem; color: var(--text-secondary);">üìû ${vehicle.customer.phone}</div>` : ''}
                            ${vehicle.customer.email ? `<div class="info-value" style="font-size: 0.875rem; color: var(--text-secondary);">üìß ${vehicle.customer.email}</div>` : ''}
                        </div>
                        ` : ''}
                        <div class="vehicle-actions">
                            <button class="btn btn-small btn-secondary" onclick="viewDetails(${vehicle.id})">Details</button>
                            <button class="btn btn-small btn-secondary" onclick="openStatusPopup(${vehicle.id}, this)">Status</button>
                        </div>
                    </div>
                </div>
            `;
        }

        // Create Sold Vehicle Card
        function createSoldVehicleCard(vehicle) {
            return `
                <div class="vehicle-card">
                    <div class="vehicle-header">
                        <div class="vehicle-stock">${vehicle.stockNumber}</div>
                        <div class="vehicle-title">${vehicle.year} ${vehicle.make} ${vehicle.model}</div>
                    </div>
                    <div class="vehicle-body">
                        <div style="margin-bottom: 1rem;">
                            <span class="status-badge status-sold">SOLD</span>
                            ${vehicle.customer?.paymentType ? `<span class="status-badge" style="background: rgba(10, 132, 255, 0.2); color: var(--accent); border: 1px solid rgba(10, 132, 255, 0.3); margin-left: 0.5rem;">${vehicle.customer.paymentType.toUpperCase()}</span>` : ''}
                        </div>
                        <div class="vehicle-info">
                            <div class="info-item">
                                <div class="info-label">Customer</div>
                                <div class="info-value">${vehicle.customer?.firstName || ''} ${vehicle.customer?.lastName || 'N/A'}</div>
                            </div>
                            <div class="info-item">
                                <div class="info-label">Payment Type</div>
                                <div class="info-value">${vehicle.customer?.paymentType || 'N/A'}</div>
                            </div>
                            <div class="info-item">
                                <div class="info-label">VIN</div>
                                <div class="info-value">${vehicle.vin}</div>
                            </div>
                            <div class="info-item">
                                <div class="info-label">Sale Date</div>
                                <div class="info-value">${vehicle.customer?.saleDate ? new Date(vehicle.customer.saleDate).toLocaleDateString() : 'N/A'}</div>
                            </div>
                        </div>
                        ${vehicle.customer && (vehicle.customer.phone || vehicle.customer.email) ? `
                        <div style="margin-top: 1rem; padding-top: 1rem; border-top: 1px solid var(--border);">
                            ${vehicle.customer.phone ? `<div class="info-value" style="font-size: 0.875rem; color: var(--text-secondary);">üìû ${vehicle.customer.phone}</div>` : ''}
                            ${vehicle.customer.email ? `<div class="info-value" style="font-size: 0.875rem; color: var(--text-secondary); margin-top: 0.25rem;">üìß ${vehicle.customer.email}</div>` : ''}
                        </div>
                        ` : ''}
                        <div class="vehicle-actions">
                            <button class="btn btn-small btn-secondary" onclick="viewSoldDetails(${vehicle.id})">View Details</button>
                            ${vehicle.tradeInId ? `<button class="btn btn-small btn-secondary" onclick="viewTradeInDetails(${vehicle.tradeInId})">View Trade-In</button>` : ''}
                        </div>
                    </div>
                </div>
            `;
        }

        // Create Trade-In Card
        function createTradeInCard(vehicle) {
            const pickedUpChecked = vehicle.pickedUp ? 'checked' : '';
            const pickedUpDate = vehicle.pickedUpDate ? new Date(vehicle.pickedUpDate).toLocaleDateString() : '';
            
            return `
                <div class="vehicle-card">
                    <div class="vehicle-header" style="background: linear-gradient(135deg, #ff9f0a, #ff6b35);">
                        <div class="vehicle-stock">${vehicle.stockNumber ? vehicle.stockNumber : 'TRADE-IN'}</div>
                        <div class="vehicle-title">${vehicle.year} ${vehicle.make} ${vehicle.model}</div>
                    </div>
                    <div class="vehicle-body">
                        ${vehicle.pickedUp ? `
                        <div style="margin-bottom: 1rem;">
                            <span class="picked-up-badge">‚úì Picked Up - ${pickedUpDate}</span>
                        </div>
                        ` : ''}
                        <div class="checkbox-group">
                            <input type="checkbox" id="pickedUp-${vehicle.id}" ${pickedUpChecked} onchange="toggleTradeInPickup(${vehicle.id}, this.checked)">
                            <label for="pickedUp-${vehicle.id}">Picked Up</label>
                        </div>
                        <div class="vehicle-info">
                            <div class="info-item">
                                <div class="info-label">VIN</div>
                                <div class="info-value">${vehicle.vin}</div>
                            </div>
                            <div class="info-item">
                                <div class="info-label">Trim</div>
                                <div class="info-value">${vehicle.trim || 'N/A'}</div>
                            </div>
                            <div class="info-item">
                                <div class="info-label">Color</div>
                                <div class="info-value">${vehicle.color}</div>
                            </div>
                            <div class="info-item">
                                <div class="info-label">Mileage</div>
                                <div class="info-value">${vehicle.mileage ? vehicle.mileage.toLocaleString() + ' mi' : 'N/A'}</div>
                            </div>
                        </div>
                        <div class="vehicle-actions">
                            <button class="btn btn-small btn-secondary" onclick="viewTradeInDetails(${vehicle.id})">View Details</button>
                            <button class="btn btn-small btn-danger" onclick="deleteTradeIn(${vehicle.id})">Delete</button>
                        </div>
                    </div>
                </div>
            `;
        }

        // Create Pickup Scheduled Card
        function createPickupScheduledCard(vehicle) {
            const pickupDateTime = new Date(`${vehicle.pickupDate}T${vehicle.pickupTime}`);
            const formattedDate = pickupDateTime.toLocaleDateString('en-US', { 
                month: 'short', 
                day: 'numeric',
                year: 'numeric'
            });
            const formattedTime = pickupDateTime.toLocaleTimeString('en-US', { 
                hour: 'numeric', 
                minute: '2-digit'
            });
            
            const customerName = vehicle.customer?.firstName || vehicle.customer?.lastName 
                ? `${vehicle.customer.firstName || ''} ${vehicle.customer.lastName || ''}`.trim()
                : 'Not set';
            
            return `
                <div class="vehicle-card">
                    <div class="vehicle-header" style="background: linear-gradient(135deg, #64d2ff, #4facfe);">
                        <div class="vehicle-stock">${vehicle.stockNumber}</div>
                        <div class="vehicle-title">${vehicle.year} ${vehicle.make} ${vehicle.model}</div>
                    </div>
                    <div class="vehicle-body">
                        <div style="margin-bottom: 1rem;">
                            <span class="status-badge status-pickup-scheduled">PICKUP SCHEDULED</span>
                        </div>
                        <div class="vehicle-info">
                            <div class="info-item">
                                <div class="info-label">Customer</div>
                                <div class="info-value">${customerName}</div>
                            </div>
                            <div class="info-item">
                                <div class="info-label">Pickup Date</div>
                                <div class="info-value">${formattedDate}</div>
                            </div>
                            <div class="info-item">
                                <div class="info-label">Pickup Time</div>
                                <div class="info-value">${formattedTime}</div>
                            </div>
                            <div class="info-item">
                                <div class="info-label">VIN</div>
                                <div class="info-value">${vehicle.vin}</div>
                            </div>
                        </div>
                        ${vehicle.customer && vehicle.customer.phone ? `
                        <div style="margin-top: 1rem; padding-top: 1rem; border-top: 1px solid var(--border);">
                            <div class="info-value" style="font-size: 0.875rem; color: var(--text-secondary);">üìû ${vehicle.customer.phone}</div>
                            ${vehicle.customer.email ? `<div class="info-value" style="font-size: 0.875rem; color: var(--text-secondary); margin-top: 0.25rem;">üìß ${vehicle.customer.email}</div>` : ''}
                        </div>
                        ` : ''}
                        <div class="vehicle-actions">
                            <button class="btn btn-small btn-secondary" onclick="viewDetails(${vehicle.id})">Details</button>
                            <button class="btn btn-small btn-secondary" onclick="openStatusPopup(${vehicle.id}, this)">Status</button>
                        </div>
                    </div>
                </div>
            `;
        }

        // Update Stats
        function updateStats() {
            const total = inventory.filter(v => v.status !== 'sold').length;
            const inStock = inventory.filter(v => v.status === 'in-stock').length;
            const sold = soldVehicles.length;
            const tradeInCount = tradeIns.length;
            
            document.getElementById('totalVehicles').textContent = total;
            document.getElementById('inStockVehicles').textContent = inStock;
            document.getElementById('soldVehicles').textContent = sold;
            document.getElementById('tradeInVehicles').textContent = tradeInCount;
        }

        // View Details
        function viewDetails(id) {
            const vehicle = inventory.find(v => v.id === id);
            if (!vehicle) return;
            
            // Store current vehicle ID for updates
            window.currentVehicleId = id;
            
            const statusClass = `status-${vehicle.status}`;
            const statusText = vehicle.status.replace('-', ' ').toUpperCase();
            
            let content = `
                <div style="margin-bottom: 1.5rem;">
                    <span class="status-badge ${statusClass}">${statusText}</span>
                </div>
                <div class="vehicle-info" style="grid-template-columns: 1fr;">
                    <div class="info-item" style="margin-bottom: 1rem;">
                        <div class="info-label">Stock Number</div>
                        <div class="info-value" style="font-size: 1.5rem;">${vehicle.stockNumber}</div>
                    </div>
                    <div class="info-item" style="margin-bottom: 1rem;">
                        <div class="info-label">VIN</div>
                        <div class="info-value">${vehicle.vin}</div>
                    </div>
                    <div class="info-item" style="margin-bottom: 1rem;">
                        <div class="info-label">Vehicle</div>
                        <div class="info-value">${vehicle.year} ${vehicle.make} ${vehicle.model} ${vehicle.trim}</div>
                    </div>
                    <div class="info-item" style="margin-bottom: 1rem;">
                        <div class="info-label">Color</div>
                        <div class="info-value">${vehicle.color}</div>
                    </div>
                    ${vehicle.fleetCompany ? `
                    <div class="info-item" style="margin-bottom: 1rem;">
                        <div class="info-label">Fleet Company</div>
                        <div class="info-value">${vehicle.fleetCompany}</div>
                    </div>
                    ` : ''}
                    <div class="info-item">
                        <div class="info-label">Date Added</div>
                        <div class="info-value">${new Date(vehicle.dateAdded).toLocaleString()}</div>
                    </div>
                </div>
            `;

            // Add customer information display if exists
            if (vehicle.customer) {
                content += `
                    <div style="margin-top: 2rem; padding-top: 2rem; border-top: 1px solid var(--border);">
                        <h3 style="font-size: 1.25rem; margin-bottom: 1rem;">Customer Information</h3>
                        <div class="vehicle-info" style="grid-template-columns: 1fr;">
                            ${vehicle.customer.firstName || vehicle.customer.lastName ? `
                            <div class="info-item" style="margin-bottom: 1rem;">
                                <div class="info-label">Customer Name</div>
                                <div class="info-value">${vehicle.customer.firstName || ''} ${vehicle.customer.lastName || ''}</div>
                            </div>
                            ` : ''}
                            ${vehicle.customer.email ? `
                            <div class="info-item" style="margin-bottom: 1rem;">
                                <div class="info-label">Email</div>
                                <div class="info-value">${vehicle.customer.email}</div>
                            </div>
                            ` : ''}
                            ${vehicle.customer.phone ? `
                            <div class="info-item" style="margin-bottom: 1rem;">
                                <div class="info-label">Phone</div>
                                <div class="info-value">${vehicle.customer.phone}</div>
                            </div>
                            ` : ''}
                            ${vehicle.customer.address ? `
                            <div class="info-item" style="margin-bottom: 1rem;">
                                <div class="info-label">Address</div>
                                <div class="info-value">${vehicle.customer.address}${vehicle.customer.city ? ', ' + vehicle.customer.city : ''}${vehicle.customer.state ? ', ' + vehicle.customer.state : ''}${vehicle.customer.zip ? ' ' + vehicle.customer.zip : ''}</div>
                            </div>
                            ` : ''}
                            ${vehicle.customer.salePrice ? `
                            <div class="info-item" style="margin-bottom: 1rem;">
                                <div class="info-label">Sale Price</div>
                                <div class="info-value">$${parseFloat(vehicle.customer.salePrice).toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2})}</div>
                            </div>
                            ` : ''}
                            ${vehicle.customer.notes ? `
                            <div class="info-item">
                                <div class="info-label">Notes</div>
                                <div class="info-value">${vehicle.customer.notes}</div>
                            </div>
                            ` : ''}
                        </div>
                    </div>
                `;
            }
            
            document.getElementById('detailContent').innerHTML = content;
            
            // Set the status dropdown
            document.getElementById('detailStatus').value = vehicle.status;
            
            // Show/hide delete button section based on whether it's a sold vehicle
            const deleteSection = document.getElementById('detailDeleteSection');
            if (soldVehicles.some(v => v.id === vehicle.id)) {
                deleteSection.style.display = 'none';
            } else {
                deleteSection.style.display = 'block';
            }
            
            // Populate customer form if customer data exists
            if (vehicle.customer) {
                document.getElementById('customerFirstName').value = vehicle.customer.firstName || '';
                document.getElementById('customerLastName').value = vehicle.customer.lastName || '';
                document.getElementById('customerEmail').value = vehicle.customer.email || '';
                document.getElementById('customerPhone').value = vehicle.customer.phone || '';
                document.getElementById('customerAddress').value = vehicle.customer.address || '';
                document.getElementById('customerCity').value = vehicle.customer.city || '';
                document.getElementById('customerState').value = vehicle.customer.state || '';
                document.getElementById('customerZip').value = vehicle.customer.zip || '';
                document.getElementById('paymentType').value = vehicle.customer.paymentType || '';
                document.getElementById('saleDate').value = vehicle.customer.saleDate || '';
                document.getElementById('notes').value = vehicle.customer.notes || '';
            } else {
                // Clear form if no customer data
                document.getElementById('customerForm').reset();
            }
            
            document.getElementById('detailModal').classList.add('active');
        }

        // Generate Label from Detail Modal
        function generateLabelFromDetail() {
            if (!window.currentVehicleId) return;
            const vehicle = inventory.find(v => v.id === window.currentVehicleId) || 
                           soldVehicles.find(v => v.id === window.currentVehicleId);
            if (!vehicle) return;
            generateLabel(vehicle.id);
        }

        // Generate Label
        function generateLabel(id) {
            // Find vehicle in inventory or sold vehicles
            const vehicle = inventory.find(v => v.id === id) || 
                           soldVehicles.find(v => v.id === id);
            
            if (!vehicle) {
                console.error('Vehicle not found for label generation:', id);
                alert('Vehicle not found. Please try again.');
                return;
            }
            
            window.currentVehicleId = id;
            
            // Set stock number header
            document.getElementById('labelStockNumber').textContent = vehicle.stockNumber;

            // Set vehicle info with explicit black text color
            const labelInfo = document.getElementById('labelInfo');
            labelInfo.innerHTML = `
                <div style="color: #000;"><strong>VIN:</strong> ${vehicle.vin}</div>
                <div style="color: #000;"><strong>Year:</strong> ${vehicle.year}</div>
                <div style="color: #000;"><strong>Make:</strong> ${vehicle.make}</div>
                <div style="color: #000;"><strong>Model:</strong> ${vehicle.model}</div>
                <div style="color: #000;"><strong>Trim:</strong> ${vehicle.trim}</div>
                <div style="color: #000;"><strong>Color:</strong> ${vehicle.color}</div>
                ${vehicle.fleetCompany ? `<div style="color: #000;"><strong>Fleet:</strong> ${vehicle.fleetCompany}</div>` : ''}
            `;

            // Generate QR code with just the VIN
            const qrContainer = document.getElementById('labelQR');
            qrContainer.innerHTML = '';

            new QRCode(qrContainer, {
                text: vehicle.vin,
                width: 80,
                height: 80,
                colorDark: "#000000",
                colorLight: "#ffffff",
                correctLevel: QRCode.CorrectLevel.H
            });
            
            document.getElementById('labelModal').classList.add('active');
        }

        // Open Status Popup
        function openStatusPopup(vehicleId, buttonOrEvent) {
            // Handle both event object and button element
            const button = buttonOrEvent?.target || buttonOrEvent;
            
            // Prevent event bubbling if it's an event object
            if (buttonOrEvent && buttonOrEvent.stopPropagation) {
                buttonOrEvent.stopPropagation();
            }
            
            // Find vehicle in inventory or sold vehicles
            const vehicle = inventory.find(v => v.id === vehicleId) || 
                           soldVehicles.find(v => v.id === vehicleId);
            
            if (!vehicle) {
                console.error('Vehicle not found:', vehicleId);
                return;
            }
            
            const popup = document.getElementById('statusPopup');
            
            if (!popup) {
                console.error('Status popup element not found!');
                return;
            }
            
            const rect = button.getBoundingClientRect();
            
            // Create status options
            const statuses = [
                { value: 'in-stock', label: 'In Stock' },
                { value: 'in-transit', label: 'In-Transit' },
                { value: 'pdi', label: 'PDI' },
                { value: 'pending-pickup', label: 'Pending Pickup' },
                { value: 'pickup-scheduled', label: 'Pickup Scheduled' },
                { value: 'sold', label: 'Sold' }
            ];
            
            popup.innerHTML = statuses.map(status => `
                <div class="status-popup-option ${vehicle.status === status.value ? 'selected' : ''}" 
                     onclick="quickStatusChange(${vehicleId}, '${status.value}')">
                    ${status.label}
                </div>
            `).join('');
            
            // Measure popup height while invisible
            popup.style.visibility = 'hidden';
            popup.style.display = 'block';
            const popupHeight = popup.offsetHeight;
            popup.style.display = 'none';
            popup.style.visibility = 'visible';
            
            // Calculate available space below and above button
            const spaceBelow = window.innerHeight - rect.bottom;
            const spaceAbove = rect.top;
            
            // Position popup intelligently
            if (spaceBelow >= popupHeight + 10) {
                // Enough space below - show below button
                popup.style.top = (rect.bottom + 5) + 'px';
                popup.style.bottom = 'auto';
            } else if (spaceAbove >= popupHeight + 10) {
                // Not enough space below but enough above - show above button
                popup.style.bottom = (window.innerHeight - rect.top + 5) + 'px';
                popup.style.top = 'auto';
            } else {
                // Not enough space either way - position at bottom of button and let it scroll
                popup.style.top = (rect.bottom + 5) + 'px';
                popup.style.bottom = 'auto';
                popup.style.maxHeight = Math.min(300, spaceBelow - 10) + 'px';
            }
            
            // Position horizontally
            const spaceRight = window.innerWidth - rect.left;
            if (spaceRight >= 200) {
                popup.style.left = rect.left + 'px';
                popup.style.right = 'auto';
            } else {
                popup.style.right = (window.innerWidth - rect.right) + 'px';
                popup.style.left = 'auto';
            }
            
            // Remove inline display style so CSS class can work
            popup.style.display = '';
            
            popup.classList.add('active');
            
            // Close popup when clicking outside
            setTimeout(() => {
                document.addEventListener('click', closeStatusPopup);
            }, 0);
        }
        
        function closeStatusPopup() {
            const popup = document.getElementById('statusPopup');
            popup.classList.remove('active');
            document.removeEventListener('click', closeStatusPopup);
        }

        // Quick Status Change from Card
        function quickStatusChange(vehicleId, newStatus) {
            closeStatusPopup(); // Close the popup
            
            const vehicleIndex = inventory.findIndex(v => v.id === vehicleId);
            if (vehicleIndex === -1) return;
            
            const vehicle = inventory[vehicleIndex];
            const oldStatus = vehicle.status;
            
            // If changing to pickup-scheduled, show modal
            if (newStatus === 'pickup-scheduled') {
                window.pendingStatusChangeVehicleId = vehicleId;
                openPickupScheduleModal();
                return;
            }
            
            // If changing to sold status, prompt for trade-in
            if (newStatus === 'sold' && oldStatus !== 'sold') {
                const hasTradeIn = confirm('Was there a trade-in vehicle with this sale?');
                
                if (hasTradeIn) {
                    window.pendingSoldVehicleId = vehicleId;
                    openTradeInModal();
                    return;
                } else {
                    vehicle.status = 'sold';
                    soldVehicles.unshift(vehicle);
                    localStorage.setItem('soldVehicles', JSON.stringify(soldVehicles));
                    localStorage.setItem('vehicleInventory', JSON.stringify(inventory));
                    
                    renderDashboard();
                    renderInventory();
                    renderInTransit();
                    renderPDI();
                    renderPendingPickup();
                    renderPickupScheduled();
                    renderSoldVehicles();
                    updateStats();
                    return;
                }
            }
            
            // Regular status change
            inventory[vehicleIndex].status = newStatus;
            localStorage.setItem('vehicleInventory', JSON.stringify(inventory));
            
            renderDashboard();
            renderInventory();
            renderInTransit();
            renderPDI();
            renderPendingPickup();
            renderPickupScheduled();
            updateStats();
        }

        // Update Vehicle Status
        function updateVehicleStatus() {
            const vehicleId = window.currentVehicleId;
            const newStatus = document.getElementById('detailStatus').value;
            const oldStatus = inventory.find(v => v.id === vehicleId)?.status;
            
            const vehicleIndex = inventory.findIndex(v => v.id === vehicleId);
            if (vehicleIndex === -1) return;
            
            // If changing to pickup-scheduled status, show pickup schedule modal
            if (newStatus === 'pickup-scheduled') {
                window.pendingStatusChangeVehicleId = vehicleId;
                closeDetailModal();
                openPickupScheduleModal();
                return;
            }
            
            // If changing to sold status, prompt for trade-in
            if (newStatus === 'sold' && oldStatus !== 'sold') {
                const hasTradeIn = confirm('Was there a trade-in vehicle with this sale?');
                
                if (hasTradeIn) {
                    // Store the vehicle ID for later association
                    window.pendingSoldVehicleId = vehicleId;
                    closeDetailModal();
                    openTradeInModal();
                    return;
                } else {
                    // Move to sold vehicles without trade-in
                    const vehicle = inventory[vehicleIndex];
                    vehicle.status = 'sold';
                    soldVehicles.unshift(vehicle);
                    localStorage.setItem('soldVehicles', JSON.stringify(soldVehicles));
                    
                    renderDashboard();
                    renderInventory();
                    renderSoldVehicles();
                    updateStats();
                    closeDetailModal();
                    alert('Vehicle marked as sold!');
                    return;
                }
            }
            
            inventory[vehicleIndex].status = newStatus;
            localStorage.setItem('vehicleInventory', JSON.stringify(inventory));
            
            renderDashboard();
            renderInventory();
            renderInTransit();
            renderPDI();
            renderPendingPickup();
            renderPickupScheduled();
            updateStats();
            
            // Refresh the detail view
            viewDetails(vehicleId);
            
            alert('Vehicle status updated successfully!');
        }

        // Save Customer Information
        function saveCustomerInfo(event) {
            event.preventDefault();
            
            const vehicleId = window.currentVehicleId;
            const vehicleIndex = inventory.findIndex(v => v.id === vehicleId);
            if (vehicleIndex === -1) return;
            
            const customerData = {
                firstName: document.getElementById('customerFirstName').value,
                lastName: document.getElementById('customerLastName').value,
                email: document.getElementById('customerEmail').value,
                phone: document.getElementById('customerPhone').value,
                address: document.getElementById('customerAddress').value,
                city: document.getElementById('customerCity').value,
                state: document.getElementById('customerState').value,
                zip: document.getElementById('customerZip').value,
                paymentType: document.getElementById('paymentType').value,
                saleDate: document.getElementById('saleDate').value,
                notes: document.getElementById('notes').value
            };
            
            inventory[vehicleIndex].customer = customerData;
            
            // If vehicle is marked as sold, move it to sold vehicles
            if (inventory[vehicleIndex].status === 'sold') {
                const vehicle = inventory[vehicleIndex];
                soldVehicles.unshift(vehicle);
                localStorage.setItem('soldVehicles', JSON.stringify(soldVehicles));
            }
            
            localStorage.setItem('vehicleInventory', JSON.stringify(inventory));
            
            renderDashboard();
            renderInventory();
            renderSoldVehicles();
            
            // Refresh the detail view
            viewDetails(vehicleId);
            
            alert('Customer information saved successfully!');
        }

        // Delete Vehicle
        function deleteVehicle(id) {
            if (!confirm('Are you sure you want to delete this vehicle?')) return;
            
            inventory = inventory.filter(v => v.id !== id);
            localStorage.setItem('vehicleInventory', JSON.stringify(inventory));
            
            renderDashboard();
            renderInventory();
            updateStats();
        }

        // Delete Trade-In
        function deleteTradeIn(id) {
            if (!confirm('Are you sure you want to delete this trade-in?')) return;
            
            tradeIns = tradeIns.filter(v => v.id !== id);
            localStorage.setItem('tradeIns', JSON.stringify(tradeIns));
            
            renderTradeIns();
            updateStats();
        }

        // Trade-In Form Submission
        document.getElementById('tradeInForm').addEventListener('submit', function(e) {
            e.preventDefault();
            
            const tradeIn = {
                id: Date.now(),
                stockNumber: document.getElementById('tradeStockNumber').value,
                vin: document.getElementById('tradeVin').value,
                year: document.getElementById('tradeYear').value,
                make: document.getElementById('tradeMake').value,
                model: document.getElementById('tradeModel').value,
                trim: document.getElementById('tradeTrim').value,
                color: document.getElementById('tradeColor').value,
                mileage: document.getElementById('tradeMileage').value,
                notes: document.getElementById('tradeNotes').value,
                dateAdded: new Date().toISOString()
            };

            tradeIns.unshift(tradeIn);
            localStorage.setItem('tradeIns', JSON.stringify(tradeIns));
            
            // If this trade-in was part of a sale, associate it
            if (window.pendingSoldVehicleId) {
                const vehicleIndex = inventory.findIndex(v => v.id === window.pendingSoldVehicleId);
                if (vehicleIndex !== -1) {
                    const vehicle = inventory[vehicleIndex];
                    vehicle.status = 'sold';
                    vehicle.tradeInId = tradeIn.id;
                    soldVehicles.unshift(vehicle);
                    localStorage.setItem('soldVehicles', JSON.stringify(soldVehicles));
                    localStorage.setItem('vehicleInventory', JSON.stringify(inventory));
                }
                window.pendingSoldVehicleId = null;
            }
            
            closeTradeInModal();
            this.reset();
            renderDashboard();
            renderInventory();
            renderSoldVehicles();
            renderTradeIns();
            updateStats();
            
            alert('Trade-in vehicle added successfully!');
        });

        // Pickup Schedule Form Submission
        document.getElementById('pickupScheduleForm').addEventListener('submit', function(e) {
            e.preventDefault();
            
            const pickupDate = document.getElementById('pickupDate').value;
            const pickupTime = document.getElementById('pickupTime').value;
            const pickupNotes = document.getElementById('pickupNotes').value;
            
            const vehicleId = window.pendingStatusChangeVehicleId;
            const vehicleIndex = inventory.findIndex(v => v.id === vehicleId);
            
            if (vehicleIndex !== -1) {
                inventory[vehicleIndex].status = 'pickup-scheduled';
                inventory[vehicleIndex].pickupDate = pickupDate;
                inventory[vehicleIndex].pickupTime = pickupTime;
                inventory[vehicleIndex].pickupNotes = pickupNotes;
                
                localStorage.setItem('vehicleInventory', JSON.stringify(inventory));
                
                renderDashboard();
                renderInventory();
                renderInTransit();
                renderPDI();
                renderPendingPickup();
                renderPickupScheduled();
                updateStats();
            }
            
            closePickupScheduleModal();
            this.reset();
            window.pendingStatusChangeVehicleId = null;
            
            alert('Pickup scheduled successfully!');
        });

        // Toggle Trade-In Pickup
        function toggleTradeInPickup(id, isChecked) {
            if (isChecked) {
                // Store the ID and open the pickup date modal
                window.pendingTradeInPickupId = id;
                openTradePickupModal();
            } else {
                // Uncheck - remove pickup status
                const tradeInIndex = tradeIns.findIndex(v => v.id === id);
                if (tradeInIndex !== -1) {
                    tradeIns[tradeInIndex].pickedUp = false;
                    tradeIns[tradeInIndex].pickedUpDate = null;
                    localStorage.setItem('tradeIns', JSON.stringify(tradeIns));
                    renderTradeIns();
                }
            }
        }

        // Trade Pickup Form Submission
        document.getElementById('tradePickupForm').addEventListener('submit', function(e) {
            e.preventDefault();
            
            const pickupDate = document.getElementById('tradePickupDate').value;
            const tradeInId = window.pendingTradeInPickupId;
            const tradeInIndex = tradeIns.findIndex(v => v.id === tradeInId);
            
            if (tradeInIndex !== -1) {
                tradeIns[tradeInIndex].pickedUp = true;
                tradeIns[tradeInIndex].pickedUpDate = pickupDate;
                localStorage.setItem('tradeIns', JSON.stringify(tradeIns));
                renderTradeIns();
            }
            
            closeTradePickupModal();
            this.reset();
            window.pendingTradeInPickupId = null;
        });

        // View Sold Vehicle Details
        function viewSoldDetails(id) {
            const vehicle = soldVehicles.find(v => v.id === id);
            if (!vehicle) return;
            
            const content = `
                <div style="margin-bottom: 1.5rem;">
                    <span class="status-badge status-sold">SOLD</span>
                    ${vehicle.customer?.paymentType ? `<span class="status-badge" style="background: rgba(10, 132, 255, 0.2); color: var(--accent); border: 1px solid rgba(10, 132, 255, 0.3); margin-left: 0.5rem;">${vehicle.customer.paymentType.toUpperCase()}</span>` : ''}
                </div>
                <div class="vehicle-info" style="grid-template-columns: 1fr;">
                    <div class="info-item" style="margin-bottom: 1rem;">
                        <div class="info-label">Stock Number</div>
                        <div class="info-value" style="font-size: 1.5rem;">${vehicle.stockNumber}</div>
                    </div>
                    <div class="info-item" style="margin-bottom: 1rem;">
                        <div class="info-label">VIN</div>
                        <div class="info-value">${vehicle.vin}</div>
                    </div>
                    <div class="info-item" style="margin-bottom: 1rem;">
                        <div class="info-label">Vehicle</div>
                        <div class="info-value">${vehicle.year} ${vehicle.make} ${vehicle.model} ${vehicle.trim}</div>
                    </div>
                    <div class="info-item" style="margin-bottom: 1rem;">
                        <div class="info-label">Color</div>
                        <div class="info-value">${vehicle.color}</div>
                    </div>
                    ${vehicle.customer ? `
                    <div style="margin-top: 2rem; padding-top: 2rem; border-top: 1px solid var(--border);">
                        <h3 style="font-size: 1.25rem; margin-bottom: 1rem;">Customer Information</h3>
                        ${vehicle.customer.firstName || vehicle.customer.lastName ? `
                        <div class="info-item" style="margin-bottom: 1rem;">
                            <div class="info-label">Customer Name</div>
                            <div class="info-value">${vehicle.customer.firstName || ''} ${vehicle.customer.lastName || ''}</div>
                        </div>
                        ` : ''}
                        ${vehicle.customer.email ? `
                        <div class="info-item" style="margin-bottom: 1rem;">
                            <div class="info-label">Email</div>
                            <div class="info-value">${vehicle.customer.email}</div>
                        </div>
                        ` : ''}
                        ${vehicle.customer.phone ? `
                        <div class="info-item" style="margin-bottom: 1rem;">
                            <div class="info-label">Phone</div>
                            <div class="info-value">${vehicle.customer.phone}</div>
                        </div>
                        ` : ''}
                        ${vehicle.customer.paymentType ? `
                        <div class="info-item" style="margin-bottom: 1rem;">
                            <div class="info-label">Payment Type</div>
                            <div class="info-value">${vehicle.customer.paymentType}</div>
                        </div>
                        ` : ''}
                        ${vehicle.customer.saleDate ? `
                        <div class="info-item" style="margin-bottom: 1rem;">
                            <div class="info-label">Sale Date</div>
                            <div class="info-value">${new Date(vehicle.customer.saleDate).toLocaleDateString()}</div>
                        </div>
                        ` : ''}
                    </div>
                    ` : ''}
                </div>
            `;
            
            document.getElementById('detailContent').innerHTML = content;
            document.getElementById('detailModal').classList.add('active');
        }

        // View Trade-In Details
        function viewTradeInDetails(id) {
            const vehicle = tradeIns.find(v => v.id === id);
            if (!vehicle) return;
            
            const content = `
                ${vehicle.pickedUp ? `
                <div style="margin-bottom: 1.5rem;">
                    <span class="picked-up-badge">‚úì Picked Up - ${new Date(vehicle.pickedUpDate).toLocaleDateString()}</span>
                </div>
                ` : ''}
                <div class="vehicle-info" style="grid-template-columns: 1fr;">
                    <div class="info-item" style="margin-bottom: 1rem;">
                        <div class="info-label">${vehicle.stockNumber ? 'Stock Number' : 'Trade-In ID'}</div>
                        <div class="info-value" style="font-size: 1.5rem;">${vehicle.stockNumber || 'TRADE-' + vehicle.id}</div>
                    </div>
                    <div class="info-item" style="margin-bottom: 1rem;">
                        <div class="info-label">VIN</div>
                        <div class="info-value">${vehicle.vin}</div>
                    </div>
                    <div class="info-item" style="margin-bottom: 1rem;">
                        <div class="info-label">Vehicle</div>
                        <div class="info-value">${vehicle.year} ${vehicle.make} ${vehicle.model} ${vehicle.trim || ''}</div>
                    </div>
                    <div class="info-item" style="margin-bottom: 1rem;">
                        <div class="info-label">Color</div>
                        <div class="info-value">${vehicle.color}</div>
                    </div>
                    ${vehicle.mileage ? `
                    <div class="info-item" style="margin-bottom: 1rem;">
                        <div class="info-label">Mileage</div>
                        <div class="info-value">${parseInt(vehicle.mileage).toLocaleString()} miles</div>
                    </div>
                    ` : ''}
                    ${vehicle.notes ? `
                    <div class="info-item" style="margin-bottom: 1rem;">
                        <div class="info-label">Notes</div>
                        <div class="info-value">${vehicle.notes}</div>
                    </div>
                    ` : ''}
                    <div class="info-item">
                        <div class="info-label">Date Added</div>
                        <div class="info-value">${new Date(vehicle.dateAdded).toLocaleString()}</div>
                    </div>
                </div>
            `;
            
            document.getElementById('detailContent').innerHTML = content;
            document.getElementById('detailModal').classList.add('active');
        }

        // Render Analytics
        function renderAnalytics() {
            renderMakeChart();
            renderTimelineChart();
        }

        function renderMakeChart() {
            const ctx = document.getElementById('makeChart');
            if (!ctx) return;
            
            const makeCounts = {};
            inventory.forEach(v => {
                makeCounts[v.make] = (makeCounts[v.make] || 0) + 1;
            });
            
            if (makeChart) {
                makeChart.destroy();
            }
            
            makeChart = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: Object.keys(makeCounts),
                    datasets: [{
                        data: Object.values(makeCounts),
                        backgroundColor: [
                            '#0071e3',
                            '#34c759',
                            '#ff9500',
                            '#ff3b30',
                            '#5856d6',
                            '#af52de',
                            '#00c7be',
                            '#ff2d55'
                        ]
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom'
                        }
                    }
                }
            });
        }

        function renderTimelineChart() {
            const ctx = document.getElementById('timelineChart');
            if (!ctx) return;
            
            const last7Days = [];
            for (let i = 6; i >= 0; i--) {
                const date = new Date();
                date.setDate(date.getDate() - i);
                last7Days.push(date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' }));
            }
            
            const counts = last7Days.map(() => 0);
            inventory.forEach(v => {
                const vehicleDate = new Date(v.dateAdded).toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
                const index = last7Days.indexOf(vehicleDate);
                if (index !== -1) {
                    counts[index]++;
                }
            });
            
            if (timelineChart) {
                timelineChart.destroy();
            }
            
            timelineChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: last7Days,
                    datasets: [{
                        label: 'Vehicles Added',
                        data: counts,
                        borderColor: '#0071e3',
                        backgroundColor: 'rgba(0, 113, 227, 0.1)',
                        tension: 0.4,
                        fill: true
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: false
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                stepSize: 1
                            }
                        }
                    }
                }
            });
        }

        // Modal Functions
        function openAddModal() {
            document.getElementById('addModal').classList.add('active');
        }

        function closeAddModal() {
            document.getElementById('addModal').classList.remove('active');
        }

        function closeDetailModal() {
            document.getElementById('detailModal').classList.remove('active');
        }

        function closeLabelModal() {
            document.getElementById('labelModal').classList.remove('active');
        }

        function openTradeInModal() {
            document.getElementById('tradeInModal').classList.add('active');
        }

        function closeTradeInModal() {
            document.getElementById('tradeInModal').classList.remove('active');
            document.getElementById('tradeInForm').reset();
        }

        function openPickupScheduleModal() {
            document.getElementById('pickupScheduleModal').classList.add('active');
        }

        function closePickupScheduleModal() {
            document.getElementById('pickupScheduleModal').classList.remove('active');
            document.getElementById('pickupScheduleForm').reset();
        }

        function openTradePickupModal() {
            document.getElementById('tradePickupModal').classList.add('active');
        }

        function closeTradePickupModal() {
            document.getElementById('tradePickupModal').classList.remove('active');
            document.getElementById('tradePickupForm').reset();
            // Uncheck the checkbox if user cancels
            if (window.pendingTradeInPickupId) {
                const checkbox = document.getElementById(`pickedUp-${window.pendingTradeInPickupId}`);
                if (checkbox) checkbox.checked = false;
                window.pendingTradeInPickupId = null;
            }
        }

        // Label Functions
        function printLabel() {
            const labelContent = document.getElementById('label').outerHTML;
            const printWindow = window.open('', '', 'width=600,height=600');
            printWindow.document.write(`
                <html>
                <head>
                    <title>Print Label</title>
                    <style>
                        body { margin: 0; padding: 20px; display: flex; justify-content: center; align-items: center; }
                        .label { width: 192px; height: 192px; background: white; border: 2px solid #000; padding: 8px; font-family: 'Courier New', monospace; }
                        .label-header { text-align: center; font-size: 18px; font-weight: bold; margin-bottom: 8px; padding-bottom: 4px; border-bottom: 2px solid #000; }
                        .label-content { display: flex; gap: 8px; }
                        .label-info { flex: 1; font-size: 8px; line-height: 1.4; }
                        .label-info div { margin-bottom: 2px; }
                        .label-qr { width: 80px; height: 80px; display: flex; align-items: center; justify-content: center; }
                        .label-qr canvas { max-width: 100%; max-height: 100%; }
                    </style>
                </head>
                <body>${labelContent}</body>
                </html>
            `);
            printWindow.document.close();
            setTimeout(() => {
                printWindow.print();
                printWindow.close();
            }, 250);
        }

        async function saveLabel() {
            const labelElement = document.getElementById('label');
            
            try {
                const canvas = await html2canvas(labelElement, {
                    backgroundColor: '#ffffff',
                    scale: 4
                });
                
                canvas.toBlob(blob => {
                    const url = URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = `label-${currentVehicle.stockNumber}.png`;
                    a.click();
                    URL.revokeObjectURL(url);
                });
            } catch (error) {
                console.error('Error saving label:', error);
                alert('Error saving label. Please try again.');
            }
        }

        async function copyLabel() {
            const labelElement = document.getElementById('label');
            
            try {
                const canvas = await html2canvas(labelElement, {
                    backgroundColor: '#ffffff',
                    scale: 4
                });
                
                canvas.toBlob(async blob => {
                    try {
                        await navigator.clipboard.write([
                            new ClipboardItem({
                                'image/png': blob
                            })
                        ]);
                        alert('Label copied to clipboard!');
                    } catch (err) {
                        console.error('Error copying to clipboard:', err);
                        alert('Error copying label. Please try the Save option instead.');
                    }
                });
            } catch (error) {
                console.error('Error copying label:', error);
                alert('Error copying label. Please try again.');
            }
        }

        // Close modals on outside click
        window.addEventListener('click', (e) => {
            if (e.target.classList.contains('modal')) {
                e.target.classList.remove('active');
            }
        });
    </script>
</body>
</html>
